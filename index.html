<!DOCTYPE html>
<html lang="it">
<head>
    <!-- ========================================
         LIBRERIE ESTERNE
         ======================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- META TAGS -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le dritte del Prof.</title>
    
    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ========================================
         CSS STYLES - INIZIO
         ======================================== -->
<style>
html, body {
  overflow: auto !important;
  height: auto !important;
  min-height: 100vh;
}
/* ===============================
   VARIABILI GLOBALI
================================ */
:root {
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --border-color: #e5e7eb;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --accent-blue: #2563eb;
  --accent-gold: #facc15;
  --accent-green: #16a34a;
  --accent-red: #dc2626;
  --radius: 12px;
}

/* ===============================
   RESET BASE
================================ */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: Inter, system-ui, Arial, sans-serif;
}

body {
  background: var(--bg-primary);
  color: var(--text-primary);
}

/* ===============================
   LAYOUT
================================ */
.layout-container {
  max-width: 1300px;
  margin: auto;
  padding: 12px;
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 16px;
}

header, nav, main, aside {
  background: var(--bg-secondary);
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
}

/* ===============================
   HEADER
================================ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
}

.logo-area {
  display: flex;
  align-items: center;
  gap: 20px;
}

.app-logo {
  height: 90px;
}

.main-title {
  font-size: 1.1rem;
  font-weight: 700;
}

.app-subtitle {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* ===============================
   NAVBAR
================================ */
.main-nav {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px;
}

.nav-link {
  text-decoration: none;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.nav-link.active {
  background: var(--accent-blue);
  color: #fff;
}

/* ===============================
   SEZIONI
================================ */
.section {
  display: none;
  padding: 14px;
}

.section.active {
  display: block;
}

.section-title {
  font-size: 1.15rem;
  font-weight: 700;
  margin-bottom: 12px;
}

/* ===============================
   TABS
================================ */
.tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.tab-btn {
  padding: 5px 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: #fff;
  font-size: 0.8rem;
  cursor: pointer;
}

.tab-btn.active {
  background: var(--accent-blue);
  color: #fff;
}

/* ===============================
   CARD BASE
================================ */
.card {
  background: #fff;
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
  overflow: hidden;
  margin-bottom: 10px;
}

.card-body {
  padding: 12px;
}

.card-title {
  font-weight: 700;
}

/* ===============================
   PRONOSTICO CARD
================================ */
.pronostico-card {
  background: #fff;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 12px;
}

.pronostico-header {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.pronostico-match {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.pronostico-match .team {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.pronostico-match img {
  width: 34px;
  height: 34px;
  object-fit: contain;
}

.vs {
  font-size: 0.7rem;
  color: var(--text-secondary);
}


/* ===============================
   ESITI GRID
================================ */
.esiti-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 8px;
}

.esito-box {
  background: #014f86 !important;
  color: #fff !important; 
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 6px;
  text-align: center;
  font-size: 0.75rem;
}

.esito-box.best {
  background: #b71c1c !important;  /* rosso scuro elegante */
  color: #fff !important;
}

/* ===============================
   ANALISI
================================ */
.pronostico-analisi {
  margin-top: 8px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  border-left: 3px solid var(--accent-blue);
  padding-left: 8px;
}

/* ===============================
   TOP5 + BOMBE
================================ */
.prediction-card {
  max-width: 900px;
  margin: auto;
}

/* ===============================
   TABELLE
================================ */
.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}

.table th,
.table td {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
  text-align: left;
}

.text-green { color: var(--accent-green); }
.text-red   { color: var(--accent-red); }
.text-gold  { color: var(--accent-gold); }

/* ===== NASCONDI CONFIDENZA OVUNQUE ===== */
.confidenza,
.star-confidenza,
.prediction-confidenza,
.pronostico-confidenza {
  display: none !important;
}


/* ===============================
   SIDEBAR
================================ */
.sidebar .card {
  margin-bottom: 12px;
}

/* ===============================
   LOADING
================================ */
.loading {
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* ===============================
   BOTTONI GENERICI
================================ */
.btn {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--accent-blue);
  color: #fff;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 700;
}

.btn-admin {
  background: #fff;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 0.75rem;
}

/* ===============================
   MOBILE
================================ */
@media (max-width: 900px) {
  .layout-container {
    grid-template-columns: 1fr;
  }
  .sidebar {
    order: -1;
  }
}


/* ===============================
   PRONOSTICI / TOP5 / BOMBE - DEFINITIVO
================================ */

.prediction-card,
.pronostico-card {
  padding: 6px 8px;
  margin-bottom: 8px;
  border-radius: 10px;
}

.prediction-header,
.pronostico-header {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #64748b;
  margin-bottom: 8px;
}


/* ===== DISATTIVA TUTTE LE ANALISI ===== */
.prediction-analysis,
.pronostico-analisi,
.x-analysis {
  display: none !important;
}


.prediction-match-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  padding: 15px 0;
}

.team-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0; /* Importante per text overflow */
}

.team-logo {
  width: 40px;
  height: 40px;
  object-fit: contain;
}

.team-name {
  font-weight: 600;
  font-size: 14px;
  text-align: center;
  word-wrap: break-word;
  max-width: 100%;
}

.bestbet-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 12px 20px;
  background: #014f86;
  border-radius: 12px;
  min-width: 80px;
  flex-shrink: 0; /* Non si comprime */
}

.bestbet-value {
  font-size: 24px;
  font-weight: 700;
  color: white;
}

.bestbet-perc {
  font-size: 13px;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
}


.prof-tips {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 8px;
  gap: 6px;
}

.prof-logo {
  width: 20px;
  height: 20px;
}

.prof-text {
  font-size: 11px;
  color: #666;
  font-weight: 600;
}


.compact-match {
  display: flex;
  align-items: center;
  justify-content: flex-start;  /* ‚úÖ NON pi√π space-between */
  padding: 6px 10px;
  border-bottom: 1px solid #e5e5e5;
  font-size: 15px;
  gap: 10px;                    /* ‚úÖ distanza controllata */
}

.compact-teams {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
  margin-right: 4px;           /* ‚úÖ avvicina l‚Äôesito */
}


.compact-time {
  width: 68px;              /* pi√π largo per data + ora */
  font-weight: 600;
  color: #333;
  font-size: 13px;
  text-align: left;
  line-height: 1.1;
}

.team-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
}

.compact-logo {
  width: 24px;              /* leggermente pi√π grandi */
  height: 24px;
  object-fit: contain;
}

.compact-bet {
  min-width: 58px;          /* ‚úÖ ora OVER entra */
  height: 30px;
  padding: 0 6px;          /* ‚úÖ si adatta al testo */
  background: #014f86; 
  color: white;
  font-weight: 800;
  font-size: 13px;         /* ‚úÖ bilanciato */
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 4px;
  white-space: nowrap;    /* ‚úÖ mai a capo */
}


/* Footer finale */
.prof-footer {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 11px;
  color: #555;
  margin-top: 8px;
}

.prof-footer img {
  width: 16px;
  height: 16px;
  border-radius: 50%;
}

/* ‚úÖ BOMBE allineate allo stile COMPACT */
#sorprese-forma-container .prediction-match-row {
  justify-content: flex-start;
  gap: 10px;
}

#sorprese-forma-container .bestbet-box {
  min-width: 58px;
  padding: 4px 6px;
  font-size: 13px;
}

.team-row span {
  font-size: 16px;
}

.compact-time {
  font-size: 12px;
  opacity: 0.85;
}


.list-header {
  display: flex;
  align-items: center;
  background: #c62828;
  color: white;
  font-weight: 700;
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 6px 6px 0 0;
  margin-bottom: 4px;
}

.lh-data {
  width: 70px;
}

.lh-partita {
  flex: 1;
}

.lh-esito {
  width: 60px;              /* ‚úÖ pi√π stretta */
  text-align: center;
}

.lr-esito {
  width: 60px;              /* ‚úÖ pi√π vicina */
  display: flex;
  justify-content: flex-start;  /* ‚úÖ non pi√π centrata lontano */
  padding-left: 6px;        /* ‚úÖ piccola distanza controllata */
}

/* Intestazione Data - Partita - Esito */
.list-header {
  display: flex;
  align-items: center;
  background: #c62828;
  color: #fff;
  font-weight: 700;
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 6px 6px 0 0;
}

.lh-data {
  width: 80px;
  border-right: 1px solid #cce4ff; /* linea verticale azzurra */
}

.lh-partita {
  flex: 1;
  padding-left: 8px;
  border-right: 1px solid #cce4ff; /* linea verticale azzurra */
}


/* Righe contenuto */
.list-row {
  display: flex;
  align-items: center;
  padding: 6px 10px;
  border-bottom: 1px solid #eeeeee;
  font-size: 14px;
}

.compact-logo {
  width: 26px;
  height: 26px;
  object-fit: contain;
}

/* Box esito (allineato e pi√π largo per "Under 2.5", "NoGol", ecc.) */
.compact-bet {
  min-width: 64px;
  height: 30px;
  padding: 0 8px;
  background: #014f86;
  color: #fff;
  font-weight: 800;
  font-size: 13px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  margin: 0; /* niente spinta laterale */
}



/* ===============================
   OVERRIDE DEFINITIVO ALLINEAMENTO
   (METTERE IN FONDO AL FILE)
================================ */

/* Colonne pi√π vicine */
.lh-data,
.lr-data {
  width: 65px !important;
}

.lh-esito,
.lr-esito {
  width: 68px !important;
  justify-content: flex-start !important;
  padding-left: 4px !important;
}

/* Partita pi√π compatta verso l‚Äôesito */
.lh-partita,
.lr-partita {
  padding-right: 4px !important;
}

/* Righe pi√π compatte */
.list-row {
  gap: 4px !important;
  font-size: 15px !important;
}

/* Pi√π spazio tra le due squadre */
.team-row {
  margin-bottom: 6px !important;
}

/* Loghi pi√π grandi */
.compact-logo {
  width: 30px !important;
  height: 30px !important;
}

/* Esito pi√π grande e pi√π vicino */
.compact-bet {
  min-width: 72px !important;
  height: 36px !important;
  font-size: 15px !important;
  margin-left: 0 !important;
}



/* Colonne esiti multiple */
.lh-esito-multi,
.lr-esito-multi {
  width: 72px;
  text-align: center;
  border-right: 1px solid #cce4ff;
}

.lh-esito-multi:last-child,
.lr-esito-multi:last-child {
  border-right: none;
}

/* Box esito principale */
.multi-bet {
  background: #014f86;
  color: #fff;
  font-weight: 800;
  font-size: 14px;
  border-radius: 6px;
  padding: 4px 6px;
  line-height: 1;
  white-space: nowrap;
}

/* Percentuale sotto */
.multi-perc {
  margin-top: 2px;
  font-size: 11px;
  font-weight: 700;
  color: #0d47a1;
}


/* ===============================
   ALIGN PRONOSTICI TABLE COLUMNS
   (OVERRIDE FINALE)
================================ */

.list-header,
.list-row {
  display: grid !important;
  grid-template-columns: 
      70px        /* Data */
      minmax(0, 1fr) /* Partita */
      80px        /* 1X2 */
      80px        /* O/U */
      80px;       /* G/NG */
  align-items: center;
  gap: 4px;       /* molto pi√π vicino */
}

/* Lascia gestire le larghezze alla griglia */
.lh-data,
.lr-data,
.lh-partita,
.lr-partita,
.lh-esito-multi,
.lr-esito-multi {
  width: auto !important;
}

/* Optional: un po' di padding per respirare */
.lr-data {
  padding-right: 6px !important;
}

.lr-partita {
  padding: 0 8px !important;
}

.lr-esito-multi {
  justify-content: center !important;
}



.lh-data,
.lr-data,
.lh-partita,
.lr-partita,
.lh-esito-multi,
.lr-esito-multi {
  width: auto !important;
  padding: 0 !important;
}

/* Centra gli esiti */
.lh-esito-multi,
.lr-esito-multi {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}



/* NAVY per box esito nella TOP5 */
.compact-bet,
.multi-bet {
  background: #014f86 !important;  /* Navy pi√π chiaro */
  color: #ffffff !important;
  font-weight: 600 !important;     /* meno bold */
  font-size: 13px !important;
}

/* =====================================
   VERSIONE MOBILE (SCREEN < 480px)
   Tabella diventa layout verticale
===================================== */

@media (max-width: 480px) {

  .list-header {
    display: none !important;
  }

  .list-row {
    display: grid !important;
    grid-template-columns: 1fr auto; /* partita | esiti */
    gap: 6px;
    padding: 10px 8px !important;
    margin-bottom: 10px;
    border-radius: 10px;
    border: 1px solid #e3e8ef;
    background: #ffffff;
  }

  /* Data + ora su un‚Äôunica riga */
  .lr-data {
    grid-column: 1 / span 2;
    font-size: 13px !important;
    font-weight: 600 !important;
    color: #475569;
    margin-bottom: 4px;
  }

  /* Squadre a sinistra */
  .lr-partita {
    padding: 0 !important;
    margin: 0 !important;
  }

  .team-row {
    margin-bottom: 4px !important;
  }

  .compact-logo {
    width: 26px !important;
    height: 26px !important;
  }

  /* Esiti uno affianco all‚Äôaltro, a destra */
  .lr-esito-multi {
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    gap: 4px !important;
  }

  /* Box esito senza icone */
  .multi-bet {
    background: #014f86 !important; /* navy chiaro */
    color: #fff !important;
    padding: 4px 6px !important;
    border-radius: 6px;
    font-size: 12px !important;
    font-weight: 500 !important;
    white-space: nowrap;
  }

  /* Percentuali */
  .multi-perc {
    font-size: 11px !important;
    font-weight: 500 !important;
    color: #334155 !important;
  }
}

/* Fix colonne pronostici */
#pronostici-content .list-row {
  display: grid !important;
  grid-template-columns: 90px 1fr 70px 70px 70px; /* Data | Partita | 3 esiti */
  align-items: center;
  gap: 6px;
}

/* Esiti compatti */
#pronostici-content .lr-esito-multi {
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Colore e stile esiti */
#pronostici-content .multi-bet {
  background: #014f86;
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

#pronostici-content .multi-perc {
  font-size: 11px;
  color: #555;
  margin-top: 2px;
}

/* ===============================
   PRONOSTICI - 4 COLONNE
================================ */

/* Griglia: Partita | 1X2 | O/U | G/NG */
#pronostici-content .list-header,
#pronostici-content .list-row {
  display: grid !important;
  grid-template-columns: 1fr 70px 70px 70px;
  align-items: center;
  gap: 6px;
  padding: 6px 4px;
}

/* HEADER */
#pronostici-content .list-header {
  background: #c62828;
  color: white;
  font-weight: 700;
  padding: 8px 4px;
  border-radius: 6px 6px 0 0;
  font-size: 14px;
  text-align: center;
}

/* PARTITA (colonna 1) */
#pronostici-content .lr-partita {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

#pronostici-content .lr-partita .team-row {
  display: flex;
  align-items: center;
  gap: 4px;
}

#pronostici-content .lr-partita span {
  font-size: 14px; /* ridotto */
  font-weight: 600;
}

/* LOGHI PICCOLI */
#pronostici-content .compact-logo {
  width: 20px;
  height: 20px;
  object-fit: contain;
}

/* ESITI (colonne 2‚Äì4) */
#pronostici-content .lr-esito-multi {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

#pronostici-content .multi-bet {
  background: #014f86; /* navy chiaro */
  padding: 3px 6px;
  border-radius: 6px;
  color: #fff;
  font-weight: 600;
  font-size: 12px;
  white-space: nowrap;
}

#pronostici-content .multi-perc {
  margin-top: 2px;
  font-size: 11px;
  color: #444;
}

/* MOBILE FIX */
@media (max-width: 480px) {
  #pronostici-content .list-header,
  #pronostici-content .list-row {
    grid-template-columns: 1fr 55px 55px 55px;
  }

  #pronostici-content .multi-bet {
    padding: 2px 5px;
    font-size: 11px;
  }

  #pronostici-content .multi-perc {
    font-size: 10px;
  }

  #pronostici-content .lr-partita span {
    font-size: 13px;
  }

  #pronostici-content .compact-logo {
    width: 18px;
    height: 18px;
  }
}


.combo-cell {
    display: flex;
    flex-direction: column;   /* COMBO SOPRA, % SOTTO */
    align-items: center;
    justify-content: center;
    gap: 4px;

    width: 140px;             /* Forza larghezza costante */
}

.combo-pill {
    background: #003B70;
    color: white;
    padding: 5px 12px;
    border-radius: 8px;
    font-size: 0.80rem;
    text-align: center;

    max-width: 140px;         /* Evita overflow */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;  /* Se troppo lunga, mette "‚Ä¶" */
}

.mini-perc {
    font-size: 0.78rem;
    color: var(--text-secondary);
}


/* Card Cartellini */
.cartellini-card {
  background: white;
  border-radius: 16px;
  padding: 0;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid #e0e0e0;
}

.cartellini-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

/* Header */
.cartellini-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
  flex-wrap: wrap;
  gap: 10px;
}

.header-left {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.data-badge, .arbitro-badge {
  font-size: 13px;
  color: #495057;
  font-weight: 500;
}

.rischio-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Match Info */
.match-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 20px;
  background: white;
  gap: 20px;
}

.team-section {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.team-logo-small {
  width: 48px;
  height: 48px;
  object-fit: contain;
}

.team-name-big {
  font-size: 18px;
  font-weight: 700;
  color: #212529;
  margin-bottom: 4px;
}

.team-stat {
  font-size: 13px;
  color: #6c757d;
}

.vs-section {
  font-size: 14px;
  font-weight: 700;
  color: #adb5bd;
  padding: 0 10px;
}

/* Previsione Box - SFONDO BIANCO/GRIGIO CHIARO */
.previsione-box {
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-top: 1px solid #e0e0e0;
  border-bottom: 1px solid #e0e0e0;
}

.previsione-title {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 16px;
  text-align: center;
  color: #212529;
}

.previsione-stats {
  display: flex;
  justify-content: space-around;
  gap: 12px;
  margin-bottom: 16px;
}

.stat-item {
  text-align: center;
  background: white;
  padding: 12px 8px;
  border-radius: 12px;
  flex: 1;
  transition: all 0.2s;
  border: 2px solid #e0e0e0;
}

.stat-item:hover {
  border-color: #adb5bd;
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-item.highlight {
  background: #fff3cd;
  border: 2px solid #ffc107;
}

.stat-icon {
  font-size: 24px;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 2px;
  color: #212529;
}

.stat-label {
  font-size: 11px;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.previsione-text {
  text-align: center;
  font-size: 13px;
  padding: 10px;
  background: white;
  border-radius: 8px;
  font-weight: 500;
  color: #495057;
  border: 1px solid #e0e0e0;
}

/* Range Box */
.range-box {
  padding: 20px;
  background: white;
}

.range-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #495057;
}

.range-bar {
  position: relative;
  height: 40px;
  background: linear-gradient(to right, #28a745, #ffc107, #fd7e14, #dc3545);
  border-radius: 20px;
  margin-bottom: 8px;
}

.range-indicator {
  position: absolute;
  top: -8px;
  transform: translateX(-50%);
  background: #212529;
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.range-indicator::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid #212529;
}

.range-labels {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #6c757d;
  margin-top: 8px;
}

.range-estimate {
  text-align: center;
  font-size: 13px;
  color: #495057;
  margin-top: 12px;
}

.range-estimate strong {
  color: #212529;
  font-weight: 700;
}

/* Giocatori Box */
.giocatori-box {
  padding: 20px;
  background: #fff9e6;
  border-top: 3px solid #ffc107;
}

.giocatori-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 12px;
  color: #856404;
}

.giocatori-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.giocatore-item {
  display: flex;
  align-items: center;
  gap: 12px;
  background: white;
  padding: 10px 12px;
  border-radius: 8px;
  transition: all 0.2s;
}

.giocatore-item:hover {
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.giocatore-rank {
  font-size: 16px;
  font-weight: 700;
  color: #adb5bd;
  min-width: 30px;
}

.giocatore-info {
  flex: 1;
}

.giocatore-nome {
  font-size: 14px;
  font-weight: 600;
  color: #212529;
}

.giocatore-squadra {
  font-size: 12px;
  color: #6c757d;
}

.giocatore-prob {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  color: #212529;
}

/* Note Box */
.note-box {
  padding: 12px 20px;
  background: #f8f9fa;
  font-size: 13px;
  color: #495057;
  font-style: italic;
  border-top: 1px solid #e0e0e0;
}

/* Responsive */
@media (max-width: 768px) {
  .match-info {
    flex-direction: column;
  }
  
  .vs-section {
    transform: rotate(90deg);
    margin: 10px 0;
  }
  
  .previsione-stats {
    flex-wrap: wrap;
  }
  
  .stat-item {
    min-width: 70px;
  }
}

/* Probabilit√† Card */
.probabilita-card {
  background: white;
  padding: 16px;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  margin-bottom: 12px;
}

.prob-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.prob-label {
  font-size: 13px;
  color: #495057;
  font-weight: 500;
}

.prob-value {
  font-size: 20px;
  font-weight: 700;
}

.prob-bar-container {
  height: 12px;
  background: #e9ecef;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 8px;
}

.prob-bar {
  height: 100%;
  transition: width 0.5s ease;
  border-radius: 6px;
}

.prob-description {
  font-size: 11px;
  color: #6c757d;
  text-align: center;
  font-style: italic;
}

.giocatori-subtitle {
  font-size: 12px;
  color: #856404;
  margin-bottom: 12px;
  font-weight: 400;
}


</style>


</head>

<body>

<div class="layout-container">

  <!-- ================= HEADER ================= -->
  <header class="header">
    <div class="logo-area" id="secret-logo-area">
      <img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP"
           alt="Le Dritte del Prof." class="app-logo">
      <div class="text-branding">
        <h1 class="main-title">Le dritte del Prof.</h1>
        <div class="app-subtitle">PRO<span>nostici</span> AI</div>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="card" style="display:none;">
      <div class="card-header">üîß Pannello Professore</div>
      <div class="card-body admin-grid">

        <button class="btn-admin" id="btn-admin-risultati">üìä Aggiorna Risultati</button>
        <button class="btn-admin" id="btn-admin-storico">üìà Aggiorna Storico</button>

        <button class="btn-admin" id="btn-admin-classifiche">üèÜ Aggiorna Classifiche</button>
        <button class="btn-admin" id="btn-admin-stats-a">‚öΩ Statistiche Serie A</button>

        <button class="btn-admin" id="btn-admin-stats-b">ü•à Statistiche Serie B</button>
        <button class="btn-admin" id="btn-admin-stats-ucl">üèÜ Statistiche Champions</button>

        <button class="btn-admin" id="btn-admin-calendario">üìÖ Aggiorna Calendario</button>
        <button class="btn-admin" id="btn-admin-assenti">üè• Cache Assenti</button>

        <button class="btn-admin" id="btn-admin-ml">ü§ñ Machine Learning</button>
        <button class="btn-admin" id="btn-admin-pronostici">üéØ Genera Pronostici</button>

        <button class="btn-admin" id="btn-admin-previsioni">üë§ Previsioni Giocatori</button>
        <button class="btn-admin" id="btn-admin-misterx">üé≠ Mister X</button>

        <button class="btn important" id="btn-admin-sequenza-manuale">‚ö° Sequenza Manuale</button>
        <button class="btn success" id="btn-admin-sequenza-automatica">üöÄ Sequenza Automatica</button>
        <button class="btn info" id="btn-admin-apprendimento" onclick="runApprendimento(this)"> üß† Analizza AI </button>
        <button class="btn warning" id="btn-admin-stato">üìä Stato Automazione</button>

      </div>
    </div>
  </header>

  <!-- ================= NAV ================= -->
  <nav class="main-nav">
    <a class="nav-link active" data-section="home">üè† Home</a>
    <a class="nav-link" data-section="classifiche">üìä Classifiche</a>
    <a class="nav-link" data-section="risultati">üìã Risultati</a>
    <a class="nav-link" data-section="prossime-partite">üìÖ Prossime</a>
    
  </nav>

  <!-- ================= MAIN ================= -->
  <main class="main-content">

   <section class="section active" id="home-section">
  <div class="tabs">
    <button class="tab-btn home-toggle-btn active" data-target="home">üè† Home</button>
    <button class="tab-btn home-toggle-btn active" data-target="daily">‚ö° Oggi</button>
    <button class="tab-btn home-toggle-btn" data-target="weekend">üèÜ Weekend</button>
    <button class="tab-btn home-toggle-btn" data-target="weekend1x2">üéØ 1X2 Weekend</button>
    <button class="tab-btn home-toggle-btn" data-target="pronostici">‚öΩ Pronostici</button>
    <button class="tab-btn home-toggle-btn" data-target="bombe">üí£ Bombe</button>
    <button class="tab-btn home-toggle-btn" data-target="ris-esatti">üéØ Risultati Esatti</button>
    <button class="tab-btn home-toggle-btn" data-target="combo">üîó Combo</button>
    <button class="tab-btn home-toggle-btn" data-target="misterx">üïµÔ∏è Mister X</button>
    <button class="tab-btn home-toggle-btn" data-target="cartellini">üü® Cartellini</button>
    <button class="tab-btn home-toggle-btn" data-target="giocatori">üìà Giocatori</button>

  </div>

  <div id="surprise-content"></div>
  <div id="sorprese-forma-content"></div>
  <div id="home-1x2-weekend" class="section" style="display:none;"></div> 
  <div id="home-content" style="display:block;"></div>
  <div id="home-bombe" style="display:none;"></div>
  <div id="home-risultati" style="display:none;"></div>
  <div id="home-combo" style="display:none;"></div>
  <div id="home-misterx" style="display:none;"></div>
  <div id="home-cartellini" style="display:none;"></div>
  <div id="home-giocatori" style="display:none;"></div>
</section>


    <section class="section" id="pronostici-section">
      <h2 class="section-title">‚öΩ Pronostici</h2>
      <div class="tabs">
        <button class="tab-btn active" data-campionato="A">Serie A</button>
        <button class="tab-btn" data-campionato="UCL">Champions</button>
        <button class="tab-btn" data-campionato="B">Serie B</button>
        <button class="tab-btn" data-campionato="CA">Serie C-A</button>
        <button class="tab-btn" data-campionato="CB">Serie C-B</button>
        <button class="tab-btn" data-campionato="CC">Serie C-C</button>
      </div>
      <div id="pronostici-content"></div>
    </section>

    <section class="section" id="classifiche-section">
      <h2 class="section-title">üìä Classifiche</h2>
      <div class="tabs">
        <button class="tab-btn active" data-campionato="A">Serie A</button>
        <button class="tab-btn" data-campionato="UCL">Champions</button>
        <button class="tab-btn" data-campionato="B">Serie B</button>
      </div>
      <div id="classifiche-content"></div>
    </section>

    <section class="section" id="risultati-section">
      <h2 class="section-title">üìã Risultati</h2>
      <div id="risultati-content"></div>
    </section>

    <section class="section" id="prossime-partite-section">
      <h2 class="section-title">üìÖ Prossime Partite</h2>

      <div class="tabs">
          <button class="tab-btn" data-sheet="A">Serie A</button>
          <button class="tab-btn" data-sheet="B">Serie B</button>
        </div>

  <!-- Loader -->
  <div id="prossime-loading" style="display:none">Caricamento...</div>

  <!-- Contenuto partite -->
  <div id="prossime-content"></div>
</section>


 <section class="section" id="cartellini-section" style="display:none;">
      <div class="card">
        <div class="card-header">üü® Cartellini</div>
        <div class="card-body" id="cartellini"></div>
      </div>
    </section>
  

  <div id="cartellini-content"></div>
</section>

    <section class="section" id="misterx-section" style="display:none;">
      <div class="card">
        <div class="card-header">üéØ Mister X</div>
        <div class="card-body" id="misterXList"></div>
      </div>

      <div id="misterX-content"></div>
    </section>


<section class="section" id="ris-esatti" style="display:none;">
    <h2 class="section-title">üéØ Risultati Esatti</h2>
    <div id="risEsattiList"></div>

      <div id="ris-esatti-content"></div>
</section>


<section class="section" id="combo" style="display:none;">
    <h2 class="section-title">üéõ Combo Consigliate</h2>
    <div id="comboList"></div>

      <div id="combo-content"></div>
</section>


    </main>

 
</div>

<!-- =======================
     MODALE APPRENDIMENTO AI
     ======================= -->
<div id="modal-apprendimento" 
     style="
        display:none;
        position:fixed; 
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.6);
        justify-content:center;
        align-items:center;
        z-index:99999;
     ">

    <div style="
        background:white;
        width:90%;
        max-width:600px;
        padding:20px;
        border-radius:12px;
        display:flex;
        flex-direction:column;
        gap:10px;
    ">
        <h2>üß† Analisi Apprendimento AI</h2>

        <!-- LOADER -->
        <div id="modal-loading" style="
            display:none;
            text-align:center;
            font-weight:bold;
            color:#2563eb;
        ">
            ‚è≥ Analisi in corso...
        </div>

        <!-- AREA LOG -->
        <pre id="modal-log" style="
            background:#111;
            color:#0f0;
            padding:10px;
            height:300px;
            overflow-y:auto;
            border-radius:8px;
            font-size:0.75rem;
        "></pre>

        <button class="btn" onclick="closeModal()">Chiudi</button>
    </div>
</div>



</body>

    <!-- ========================================
     JAVASCRIPT CODE
     ======================================== -->
<script>

function resizeIframe() {
  const height = document.documentElement.scrollHeight;
  window.parent.postMessage({ height: height, type: 'resize' }, '*');
}

window.addEventListener('load', resizeIframe);
window.addEventListener('resize', resizeIframe);

// ========================================
// GLOBAL STATE & CACHE
// ========================================
let state = { 
    activeSection: 'home', 
    activeCampionato: 'A',
    socialCampionato: 'A'
};

let cache = { 
    top5Daily: null, 
    top5Weekend: null,
    pronostici: { A: null, B: null, CA: null, CB: null, CC: null, UCL: null }, 
    risultati: { A: null, B: null, CA: null, CB: null, CC: null, UCL: null }, 
    classifiche: { A: null, B: null, CA: null, CB: null, CC: null, UCL: null }, 
    statistiche: { A: null, B: null, UCL: null },
    socialData: { A: null, B: null, CA: null, CB: null, CC: null, UCL: null }
};

let homeToggleState = 'daily';

// ========================================
// UTILITY: Google Apps Script Runner
// ========================================
function runGAS(funcName, ...args) {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)[funcName](...args);
    });
}

// ========================================
// INITIALIZATION FUNCTIONS
// ========================================

document.addEventListener('DOMContentLoaded', () => {
    initNav();
    initTabs();
    initHomeToggles();
    initSocialTabs();
    setupSecretUpdate();
    loadHomePage();
});

// ========================================
// NAVIGATION & TAB HANDLERS
// ========================================

function initNav() {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', e => { 
            e.preventDefault(); 
            showSection(link.dataset.section); 
        });
    });
}







function initTabs() {
  document.querySelectorAll('.tab-btn').forEach(tab => {
    tab.addEventListener('click', () => {

      const section = tab.closest('.section');
      if (!section) return;

      const sectionId = section.id;
      state.activeCampionato = tab.dataset.campionato;

      updateActiveTabs(`#${sectionId}`, state.activeCampionato);

      if (sectionId.includes('pronostici')) {
        loadPronostici(state.activeCampionato);

      } else if (sectionId.includes('risultati')) {
        loadRisultati(state.activeCampionato);

      } else if (sectionId.includes('classifiche')) {
        loadClassifichePerCampionato(state.activeCampionato);

      } else if (sectionId.includes('statistiche')) {
        loadStatistiche();

      } else if (sectionId.includes('cartellini')) {
        // ‚¨áÔ∏è attende il rendering del tab
        requestAnimationFrame(() => {
          const container = document.getElementById('cartellini-content');
          if (container) {
            loadCartellini(state.activeCampionato);
          } else {
            console.warn('cartellini-content non presente nel DOM');
          }
        });
      }

    });
  });
}









function initHomeToggles() {
  document.querySelectorAll('.home-toggle-btn').forEach(btn => {

    btn.addEventListener('click', () => {

      // ===============================
      // STATO ATTIVO TAB
      // ===============================
      document.querySelectorAll('.home-toggle-btn')
        .forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const target = btn.dataset.target;

      // ===============================
      // NASCONDO TUTTI I CONTENITORI HOME
      // ===============================
      document.getElementById("home-content").style.display = "none";
      document.getElementById("home-bombe").style.display = "none";
      document.getElementById("home-risultati").style.display = "none";
      document.getElementById("home-combo").style.display = "none";
      document.getElementById("home-misterx").style.display = "none";

      const h1x2 = document.getElementById("home-1x2-weekend");
      if (h1x2) h1x2.style.display = "none";

      // RESET CONTENUTI EXTRA
      const sc = document.getElementById("surprise-container");
      if (sc) sc.style.display = "none";

      const sf = document.getElementById("sorprese-forma-container");
      if (sf) sf.style.display = "none";

      // ===============================
      // SWITCH TAB HOME
      // ===============================
      switch (target) {

        
        case "home":
          document.getElementById("home-content").style.display = "block";
          caricaHome('daily');
          break;
        
        
        case "daily":
          document.getElementById("home-content").style.display = "block";
          caricaHome('daily');
          break;

        case "weekend":
          document.getElementById("home-content").style.display = "block";
          caricaHome('weekend');
          break;

        case "weekend1x2":
          if (h1x2) h1x2.style.display = "block";
          loadTop1X2Weekend_Home();
          break;

          case "pronostici":
            // üîí Pronostici NON √® un contenuto home
            // usiamo la sezione principale
            state.activeSection = 'pronostici';
            showSection('pronostici');
            return; // 


        case "bombe":
          document.getElementById("home-bombe").style.display = "block";
          caricaBombe();
          break;

        case "ris-esatti":
          document.getElementById("home-risultati").style.display = "block";
          loadRisultatiEsatti();
          break;

        case "combo":
          document.getElementById("home-combo").style.display = "block";
          loadComboConsigliate();
          break;

        case "misterx":
          document.getElementById("home-misterx").style.display = "block";
          loadMisterX_Home();
          break;

        case "cartellini":
        document.getElementById("home-cartellini").style.display = "block";
        loadCartellini(state.activeCampionato);
        break;

        case "giocatori":
        document.getElementById("home-giocatori").style.display = "block";
         loadGiocatori_Home();
        break;

      }

    });

  });
}



/* ---------------------
   FUNZIONI DI SUPPORTO
---------------------- */

function hideAllHomeContainers() {
    const ids = [
        "home-content",
        "home-bombe",
        "home-risultati",
        "home-combo",
        "home-misterx",
        "surprise-content",
        "sorprese-forma-content",
        "home-cartellini",
        "home-giocatori"
    ];

    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
    });
}

function show(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = "block";
}



function showSection(sectionName) {
    if (sectionName === 'home') {
    state.activeSection = 'home';
    }
    state.activeSection = sectionName;
    document.querySelectorAll('.nav-link').forEach(l => 
        l.classList.toggle('active', l.dataset.section === sectionName)
    );
    document.querySelectorAll('.section').forEach(s => 
        s.classList.toggle('active', s.id === `${sectionName}-section`)
    );

    if (['pronostici', 'classifiche', 'risultati', 'statistiche'].includes(sectionName)) {
        state.activeCampionato = 'A';
        updateActiveTabs(`#${sectionName}-section`, 'A');
    }

    switch(sectionName) {
        case 'home':
    // Mostra la home
    loadHomePage();

    // üîÅ RESET toggle home
    document.querySelectorAll('.home-toggle-btn').forEach(b =>
        b.classList.remove('active')
    );

    const dailyBtn = document.querySelector('.home-toggle-btn[data-target="daily"]');
    if (dailyBtn) dailyBtn.classList.add('active');

    // üîÅ NASCONDI sezioni non-home
    const pron = document.getElementById('pronostici-section');
    if (pron) pron.classList.remove('active');

    break;
        case 'pronostici': loadPronostici(state.activeCampionato); break;
        case 'classifiche': loadClassifichePerCampionato(state.activeCampionato); break;
        case 'risultati': loadRisultati(state.activeCampionato); break;
        case 'statistiche': loadStatistiche(); break;
        case 'cartellini': loadCartellini(state.activeCampionato); break;
        case 'misterx': loadMisterX_Home(); break;  
        case 'prossime-partite': caricaProssime('A'); break;
        case 'ris-esatti': document.getElementById('ris-esatti').style.display = 'block';   loadRisultatiEsatti(); break;
        case 'combo': document.getElementById('combo').style.display = 'block'; loadComboConsigliate();  break;

    }
}

function updateActiveTabs(selector, activeCamp) {
    document.querySelectorAll(`${selector} .tab-btn`).forEach(t => 
        t.classList.toggle('active', t.dataset.campionato === activeCamp)
    );
}

function setLoading(id, msg) {
    const c = document.getElementById(id);
    if(c) c.innerHTML = `<div class="loading"><div class="spinner"></div><p>${msg}</p></div>`;
}

function setError(id, err) {
    const c = document.getElementById(id);
    if(c) c.innerHTML = `<div class="card" style="background: var(--accent-red);"><div class="card-body"><strong>Errore:</strong> ${err.message || err}</div></div>`;
}

function normalizzaLogo(logo) {
    if (!logo) return '';

    logo = logo.trim();

    // Se √® gi√† una dataURL completa
    if (logo.startsWith('data:image')) {
        return logo;
    }

    // Se √® base64 puro
    if (logo.length > 100) {
        return `data:image/png;base64,${logo}`;
    }

    // Altrimenti √® un URL normale
    return logo;
}


function caricaBombe() {
  const container = document.getElementById("home-bombe");

  container.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>Caricamento Bombe del Prof...</p>
    </div>
  `;

  runGAS('getBombe')
    .then(res => {

      if (!res?.success || !res.bombe?.length) {
        container.innerHTML = `
          <div class="card">
            <div class="card-body text-center">
              üí£ Nessuna bomba disponibile al momento.
            </div>
          </div>`;
        return;
      }

      let html = '';

      res.bombe.forEach((b, i) => {

        const perc = Number(b.prob || 0);

        html += `
          <div class="prediction-card">

            <div class="prediction-header">
              <span>üí£ BOMBA ${i + 1}</span>
              <span>${b.campionato} | ${b.data}</span>
            </div>

            <div class="prediction-match-row">

              <div class="team-block">
                ${b.home_logo ? `<img class="team-logo" src="${b.home_logo}">` : ''}
                <div class="team-name">${b.home}</div>
              </div>

              <div class="bestbet-box">
                <div class="bestbet-value">${b.bet}</div>
                <div class="bestbet-perc">${perc > 0 ? perc.toFixed(0) + '%' : '‚Äî'}</div>
              </div>

              <div class="team-block">
                ${b.away_logo ? `<img class="team-logo" src="${b.away_logo}">` : ''}
                <div class="team-name">${b.away}</div>
              </div>

            </div>

          </div>
        `;
      });

      container.innerHTML = html;

    })
    .catch(() => {
      container.innerHTML = `
        <div class="card">
          <div class="card-body text-center">‚ùå Errore caricamento Bombe</div>
        </div>`;
    });
}



// ========================================
// DATA LOADING FUNCTIONS
// ========================================

function loadHomePage() {
    loadSorpresa();
    loadSorpreseForma();
    loadTop5Daily();
   

    document.querySelector('.home-toggle-btn[data-target="daily"]').classList.add('active');
    document.querySelector('.home-toggle-btn[data-target="weekend"]').classList.remove('active');
}



async function loadTop5Weekend() { 
    const containerId = 'home-content';

    if (cache.top5Weekend) {
        displayTop5(cache.top5Weekend, containerId, 'Nessuna dritta per il weekend.');

             return;
    }

    setLoading(containerId, 'Cerco le dritte del Weekend...');

    try {
        const res = await runGAS('getTop5PronosticiDelWeekend');
        if (res?.success) { 
            cache.top5Weekend = res.top5;

            displayTop5(res.top5, containerId, 'Nessuna dritta per il weekend.');

            
        } else {
            throw new Error(res?.error || "Caricamento fallito.");
        }
    } catch (err) {
        setError(containerId, err);
    }
}


async function loadTop5Daily() { 
    const containerId = 'home-content';

    // ‚úÖ Se √® gi√† in cache, mostra e aggiungi il pulsante
    if (cache.top5Daily) {
        displayTop5(cache.top5Daily, containerId, 'Nessuna dritta per oggi.');

       return;
    }

    setLoading(containerId, 'Cerco le dritte di oggi...');

    try {
        const res = await runGAS('getTop5PronosticiDelGiorno');

        if (res?.success) { 
            cache.top5Daily = res.top5; 
            displayTop5(res.top5, containerId, 'Nessuna dritta per oggi.');

         } else {
            throw new Error(res?.error || "Caricamento fallito.");
        }

    } catch (err) { 
        setError(containerId, err); 
    }
}


async function loadSorpresa() {
    const box = document.getElementById('surprise-container');
    if (!box) return; // <<--- FIX DEFINITIVO

    try {
        const res = await runGAS('getPronosticoSorpresa');

        if (res?.success && res.sorpresa) {
            box.style.display = 'block';
            displaySorpresa(res.sorpresa);
        } else {
            box.style.display = 'none';
        }

    } catch (e) {
        console.error("Errore Sorpresa AI:", e);
        box.style.display = 'none';
    }
}

async function loadSorpreseForma() {
    const box = document.getElementById('sorprese-forma-container');
    if (!box) return; // <<--- FIX DEFINITIVO

    try {
        const res = await runGAS('getSorpreseBasateSullaForma');

        if (res.success && res.sorprese?.length > 0) {
            box.style.display = 'block';
            displaySorpreseForma(res.sorprese);
        } else {
            box.style.display = 'none';
        }

    } catch (e) {
        console.error("Nessuna 'Bomba' (forma) trovata:", e);
        box.style.display = 'none';
    }
}


async function loadPronostici(prefix) {
    if (cache.pronostici[prefix]) return displayPronostici(cache.pronostici[prefix], prefix);
    setLoading('pronostici-content', `Analisi Serie ${prefix}...`);
    try {
        const res = await runGAS('generaPronosticiCompletiPerHTML', prefix);
        if (res?.success) { 
            cache.pronostici[prefix] = res; 
            displayPronostici(res, prefix); 
        } else throw new Error(res?.error || "Fallito.");
    } catch (err) { setError('pronostici-content', err); }
}

async function loadRisultati(prefix) {
    if (cache.risultati[prefix]) return displayRisultati(cache.risultati[prefix], prefix);
    setLoading('risultati-content', `Recupero risultati Serie ${prefix}...`);
    try {
        const res = await runGAS('getRisultatiGiornataPrecedente', prefix);
        if (res?.success) { 
            cache.risultati[prefix] = res; 
            displayRisultati(res, prefix); 
        } else throw new Error(res?.error || "Fallito.");
    } catch (err) { setError('risultati-content', err); }
}

async function loadClassifichePerCampionato(prefix) {
    if (cache.classifiche[prefix]) return displayClassifichePerCampionato(prefix);
    setLoading('classifiche-content', `Caricamento Serie ${prefix}...`);
    try {
        const res = await runGAS('getClassifiche');
        if (res?.success) { 
            Object.keys(res.campionati).forEach(key => {
                cache.classifiche[key] = res.campionati[key];
            });
            displayClassifichePerCampionato(prefix); 
        } else throw new Error(res?.message || "Fallito.");
    } catch (err) { setError('classifiche-content', err); }
}

async function loadStatistiche() {
  const container = document.getElementById('statistiche-content');
  if (!container) return;

  setLoading('statistiche-content', 'Analisi giocatori in corso...');

  try {
    const res = await runGAS('getPrevisioniGiocatori', state.activeCampionato);

    if (res?.success && res.marcatori?.length) {
      displayStatistiche(res);
    } else {
      container.innerHTML = `
        <div class="card">
          <div class="card-body text-center text-secondary">
            Nessuna statistica giocatori disponibile.
          </div>
        </div>`;
    }

  } catch (err) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-red">
          Errore caricamento giocatori
        </div>
      </div>`;
  }
}

async function loadGiocatori_Home() {
  const container = document.getElementById('home-giocatori');
  if (!container) return;

  setLoading('home-giocatori', 'Caricamento giocatori...');

  try {
    const res = await runGAS('getPrevisioniGiocatori', 'A');

    if (res?.success) {
      displayStatisticheHome(res, 'home-giocatori');
    } else {
      container.innerHTML = `
        <div class="card">
          <div class="card-body text-center text-secondary">
            Nessun dato giocatori.
          </div>
        </div>`;
    }

  } catch (e) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-red">
          Errore giocatori Home
        </div>
      </div>`;
  }
}





function displayCartellini(list) {
  const container = document.getElementById("cartellini-content");

  if (!list || !list.length) {
    container.innerHTML = '<div class="card"><div class="card-body text-center">Nessuna previsione cartellini disponibile.</div></div>';
    return;
  }

  container.innerHTML = '';
  
  list.forEach(p => {
    const card = createCartelliniCard(p);
    container.appendChild(card);
  });
}

function createCartelliniCard(p) {
  const card = document.createElement('div');
  card.className = 'cartellini-card';
  
  const casa = p.casa || p.partita?.split(' - ')[0] || 'N/D';
  const trasf = p.trasferta || p.partita?.split(' - ')[1] || 'N/D';
  
  const cartelliniTotali = Number(p.cartelliniTotali) || 0;
  const gialli = Number(p.gialli) || 0;
  const rossi = Number(p.rossi) || 0;
  const probabilitaMedia = Number(p.probabilitaMedia) || 0;
  const livelloRischio = p.livelloRischio || 'MEDIO';
  const arbitro = p.arbitro || 'N/D';
  const severita = p.severitaArbitro || 'NORMALE';
  
  // Colori
  let badgeColor = '#28a745';
  let badgeBg = '#d4edda';
  if (livelloRischio === 'MEDIO') {
    badgeColor = '#ffc107';
    badgeBg = '#fff3cd';
  } else if (livelloRischio === 'ALTO') {
    badgeColor = '#fd7e14';
    badgeBg = '#ffe5d0';
  } else if (livelloRischio === 'MOLTO ALTO') {
    badgeColor = '#dc3545';
    badgeBg = '#f8d7da';
  }
  
  // ‚úÖ Testo pi√π chiaro
  let spiegazioneRischio = '';
  if (livelloRischio === 'MOLTO ALTO') {
    spiegazioneRischio = 'Partita molto nervosa. Attesi numerosi interventi dell\'arbitro.';
  } else if (livelloRischio === 'ALTO') {
    spiegazioneRischio = 'Partita tesa. Probabile alto numero di cartellini.';
  } else if (livelloRischio === 'MEDIO') {
    spiegazioneRischio = 'Partita nella media. Cartellini in linea con la stagione.';
  } else {
    spiegazioneRischio = 'Partita tranquilla. Pochi cartellini attesi.';
  }
  
  // Icona arbitro
  let arbitroIcon = 'üë®‚Äç‚öñÔ∏è';
  if (severita === 'SEVERO' || severita === 'MOLTO SEVERO') {
    arbitroIcon = 'üö®';
  } else if (severita === 'PERMISSIVO') {
    arbitroIcon = 'üòå';
  }
  
  const rangeMin = Math.max(0, cartelliniTotali - 2);
  const rangeMax = cartelliniTotali + 2;
  const rangePercent = Math.min(100, (cartelliniTotali / 20) * 100);

  // Header
  const header = document.createElement('div');
  header.className = 'cartellini-header';
  header.innerHTML = `
    <div class="header-left">
      <span class="data-badge">üìÖ ${p.data || 'Data N/D'}</span>
      <span class="arbitro-badge">
        ${arbitroIcon} ${arbitro} 
        <small style="color: #999; font-weight: 400;">(${severita})</small>
      </span>
    </div>
    <div class="rischio-badge" style="background: ${badgeBg}; color: ${badgeColor};">
      ${livelloRischio}
    </div>
  `;
  
  // Match info
  const matchInfo = document.createElement('div');
  matchInfo.className = 'match-info';
  matchInfo.innerHTML = `
    <div class="team-section">
      <div>
        <div class="team-name-big">${casa}</div>
        <div class="team-stat">${p.cartelliniCasa || 0} cartellini previsti</div>
      </div>
    </div>
    <div class="vs-section">VS</div>
    <div class="team-section">
      <div>
        <div class="team-name-big">${trasf}</div>
        <div class="team-stat">${p.cartelliniTrasferta || 0} cartellini previsti</div>
      </div>
    </div>
  `;
  
  // Previsione box
  const prevBox = document.createElement('div');
  prevBox.className = 'previsione-box';
  prevBox.innerHTML = `
    <div class="previsione-title">üìã Previsione Cartellini</div>
    <div class="previsione-stats">
      <div class="stat-item">
        <div class="stat-icon">üü®</div>
        <div class="stat-value">${gialli}</div>
        <div class="stat-label">Gialli</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">üü•</div>
        <div class="stat-value">${rossi}</div>
        <div class="stat-label">Rossi</div>
      </div>
      <div class="stat-item highlight">
        <div class="stat-icon">üìä</div>
        <div class="stat-value">${cartelliniTotali}</div>
        <div class="stat-label">Totali</div>
      </div>
    </div>
    <div class="previsione-text">${spiegazioneRischio}</div>
  `;
  
  // ‚úÖ Range box con spiegazione migliore
  const rangeBox = document.createElement('div');
  rangeBox.className = 'range-box';
  rangeBox.innerHTML = `
    <div class="range-title">üéØ Analisi Probabilit√†</div>
    <div class="probabilita-card">
      <div class="prob-row">
        <span class="prob-label">Indice di nervosismo partita:</span>
        <span class="prob-value" style="color: ${badgeColor}; font-weight: 700;">${probabilitaMedia}%</span>
      </div>
      <div class="prob-bar-container">
        <div class="prob-bar" style="width: ${probabilitaMedia}%; background: ${badgeColor};"></div>
      </div>
      <div class="prob-description">
        Basato su: storico giocatori, severit√† arbitro e importanza della partita
      </div>
    </div>
    <div class="range-estimate">
      Range atteso: <strong>${rangeMin} - ${rangeMax}</strong> cartellini totali
    </div>
  `;
  
  // Giocatori a rischio
  let giocatoriBox = '';
  if (p.giocatoriRischio && p.giocatoriRischio.length > 0) {
    const giocatoriHTML = p.giocatoriRischio.map((g, idx) => {
      const prob = Number(g.probabilita) || 0;
      let bgColor = '#d4edda';
      if (prob >= 50) bgColor = '#f8d7da';
      else if (prob >= 40) bgColor = '#fff3cd';
      
      return `
        <div class="giocatore-item">
          <div class="giocatore-rank">#${idx + 1}</div>
          <div class="giocatore-info">
            <div class="giocatore-nome">${g.nome || 'N/D'}</div>
            <div class="giocatore-squadra">${g.squadra || 'N/D'}</div>
          </div>
          <div class="giocatore-prob" style="background: ${bgColor}">
            ${prob}%
          </div>
        </div>
      `;
    }).join('');
    
    giocatoriBox = `
      <div class="giocatori-box">
        <div class="giocatori-title">‚ö†Ô∏è Giocatori pi√π a rischio cartellino</div>
        <div class="giocatori-subtitle">Probabilit√† di ricevere un cartellino in questa partita</div>
        <div class="giocatori-list">
          ${giocatoriHTML}
        </div>
      </div>
    `;
  }
  
  card.appendChild(header);
  card.appendChild(matchInfo);
  card.appendChild(prevBox);
  card.appendChild(rangeBox);
  if (giocatoriBox) {
    const gBox = document.createElement('div');
    gBox.innerHTML = giocatoriBox;
    card.appendChild(gBox.firstElementChild);
  }
  
  return card;
}










// ‚úÖ Funzione helper per escapare HTML
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ‚úÖ Funzione helper per costruire la lista giocatori
function buildGiocatoriRischio(giocatori) {
  if (!giocatori || !giocatori.length) return '';
  
  const items = giocatori.map((g, idx) => {
    const nome = escapeHtml(g.nome || 'N/D');
    const squadra = escapeHtml(g.squadra || 'N/D');
    const prob = Number(g.probabilita) || 0;
    
    let bgColor = '#d4edda';
    if (prob >= 50) bgColor = '#f8d7da';
    else if (prob >= 40) bgColor = '#fff3cd';
    
    return `
      <div class="giocatore-item">
        <div class="giocatore-rank">#${idx + 1}</div>
        <div class="giocatore-info">
          <div class="giocatore-nome">${nome}</div>
          <div class="giocatore-squadra">${squadra}</div>
        </div>
        <div class="giocatore-prob" style="background: ${bgColor}">
          ${prob}%
        </div>
      </div>
    `;
  }).join('');
  
  return `
    <div class="giocatori-box">
      <div class="giocatori-title">‚ö†Ô∏è Giocatori pi√π a rischio</div>
      <div class="giocatori-list">
        ${items}
      </div>
    </div>
  `;
}


async function loadCartellini(prefix) {
  const actualPrefix = prefix || 'A';
  const container = document.getElementById('cartellini-content');

  if (!container) {
    console.warn('cartellini-content non presente nel DOM');
    return;
  }

  container.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>Analisi cartellini Serie ${actualPrefix}...</p>
    </div>
  `;

  try {
    const res = await runGAS("getCartelliniForWeb", actualPrefix);
    console.log("RISPOSTA CARTELLINI:", res);

    if (res && res.success) {
    if (Array.isArray(res.cartellini) && res.cartellini.length > 0) {
        displayCartellini(res.cartellini);
    } else {
        const container = document.getElementById('cartellini-content');
        if (container) {
            container.innerHTML = `
              <div class="card">
                <div class="card-body text-center">
                  Nessuna previsione cartellini disponibile.
                </div>
              </div>`;
        }
    }
}

  } catch (err) {
    console.error('Errore loadCartellini:', err);
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center">
          <div style="color: var(--accent-red);">‚ùå Errore cartellini</div>
          <button class="btn" onclick="loadCartellini('${actualPrefix}')">üîÑ Ricarica</button>
        </div>
      </div>`;
  }
}




// ========================================
// DISPLAY FUNCTIONS
// ========================================

function displaySorpresa(s) {
  const c = document.getElementById('surprise-container');
  const content = document.getElementById('surprise-content');

  if (!c || !content || !s) return;

  c.style.display = 'block';
  c.style.opacity = '0';
  setTimeout(() => {
    c.style.transition = 'opacity 0.6s';
    c.style.opacity = '1';
  }, 50);

  // Estrazione squadre
  const parts = (s.partita || '').split(' - ');
  const casa = parts[0] || '';
  const trasf = parts[1] || '';

  // Data + ora senza secondi
  let data = '';
  let ora = '';
  if (s.data && s.data.includes(' ')) {
    const d = s.data.split(' ');
    data = d[0].substring(0, 5);
    ora = d[1].substring(0, 5);
  } else if (s.data) {
    ora = s.data.substring(0, 5);
  }

  const bestLabel = s.consiglio || '';

  let html = '';

  // ‚úÖ Intestazione tabella
  html += '<div class="list-header">';
  html += '<div class="lh-data">Data</div>';
  html += '<div class="lh-partita">Partita</div>';
  html += '<div class="lh-esito">Esito</div>';
  html += '</div>';

  // ‚úÖ Riga singola BOMBA
  html += '<div class="list-row">';

  // Colonna data
  html += '<div class="lr-data">';
  html += data + '<br>' + ora;
  html += '</div>';

  // Colonna partita
  html += '<div class="lr-partita">';

  html += '<div class="team-row">';
  if (s.logoCasa) {
    html += '<img src="' + s.logoCasa + '" class="compact-logo">';
  }
  html += '<span>' + casa + '</span>';
  html += '</div>';

  html += '<div class="team-row">';
  if (s.logoTrasferta) {
    html += '<img src="' + s.logoTrasferta + '" class="compact-logo">';
  }
  html += '<span>' + trasf + '</span>';
  html += '</div>';

  html += '</div>';

  // Colonna esito
  html += '<div class="lr-esito">';
  html += '<div class="compact-bet">' + bestLabel + '</div>';
  html += '</div>';

  html += '</div>';

  // ‚úÖ Footer
  html += '<div class="prof-footer">';
  html += '<img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">';
  html += '<span>By Le dritte del Prof.</span>';
  html += '</div>';

  content.innerHTML = html;
}



function displayTop5(top5, containerId, fallbackMessage) {
  var c = document.getElementById(containerId);
  if (!top5 || !top5.length) {
    c.innerHTML = fallbackMessage;
    return;
  }

  var html = '';

  // Intestazione
  html += `
    <div class="list-header">
      <div class="lh-data">Data</div>
      <div class="lh-partita">Partita</div>
      <div class="lh-esito">Esito</div>
    </div>
  `;

  top5.forEach(function(p) {

    var parts = (p.partita || '').split(' - ');
    var casa = parts[0] || '';
    var trasf = parts[1] || '';

    // ===============================
    // üìå PARSING DATA + ORA (FIX)
    // ===============================
    var dataTxt = '';
    var ora = '';

    if (p.data && p.data.indexOf(' ') > -1) {
      var d = p.data.split(' ');
      dataTxt = d[0].substring(0, 5);  // es. "06/12"
      ora = d[1].substring(0, 5);      // es. "18:30"
    } else if (p.data) {
      ora = p.data.substring(0, 5);    // fallback
    }

    // üîß COSTRUISCI "DATA - ORA" SOLO SE ENTRAMBI ESISTONO
    var dataOra = '';
    if (dataTxt && ora) dataOra = dataTxt + ' - ' + ora;
    else if (dataTxt) dataOra = dataTxt;
    else if (ora) dataOra = ora;

    var bestLabel = p.bestLabel || '';

    html += '<div class="list-row">';

    // DATA
    html += '<div class="lr-data">' + dataOra + '</div>';

    // PARTITA
    html += '<div class="lr-partita">';
    html += '<div class="team-row">';
    var logoCasa = p.logoCasa || p.home_logo || p.logo_home || '';
if (logoCasa) {
  html += '<img src="' + logoCasa + '" class="compact-logo">';
}
    html += '<span>' + casa + '</span>';
    html += '</div>';

    html += '<div class="team-row">';
    var logoTrasf = p.logoTrasferta || p.away_logo || p.logo_away || '';
if (logoTrasf) {
  html += '<img src="' + logoTrasf + '" class="compact-logo">';
}

    html += '<span>' + trasf + '</span>';
    html += '</div>';
    html += '</div>';

    // ESITO
    html += `
      <div class="lr-esito">
        <div class="compact-bet">${bestLabel}</div>
      </div>
    `;

    html += '</div>'; // fine riga
  });

  // FOOTER
  html += `
    <div class="prof-footer">
      <img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">
      <span>By Le dritte del Prof.</span>
    </div>
  `;

  c.innerHTML = html;
}


function displayPronostici(data) {
  var c = document.getElementById('pronostici-content');
  if (!data.pronostici || !data.pronostici.length) {
    c.innerHTML = '<div class="card"><div class="card-body text-center">Nessun pronostico disponibile.</div></div>';
    return;
  }

  var html = '';

  // HEADER (senza data)
  html += '<div class="list-header">';
  html += '<div class="lh-partita">Partita</div>';
  html += '<div class="lh-esito-multi">1X2</div>';
  html += '<div class="lh-esito-multi">O/U</div>';
  html += '<div class="lh-esito-multi">G/NG</div>';
  html += '</div>';

  data.pronostici.forEach(function(p) {

    var [casa, trasf] = (p.partita || '').split(' - ');

    var es1x2 = p.consiglio1X2 || '‚Äî';
    var esOU  = p.consiglioOverUnder || '‚Äî';
    var esGN  = p.consiglioGol || '‚Äî';

    var perc1x2 = p.prob1X2_val || '';
    var percOU  = p.probOU_val || '';
    var percGN  = p.probGol_val || '';

    html += '<div class="list-row">';

    // PARTITA
    html += '<div class="lr-partita">';
    html += '<div class="team-row">';
    if (p.logoCasa) html += '<img src="' + p.logoCasa + '" class="compact-logo">';
    html += '<span>' + casa + '</span>';
    html += '</div>';

    html += '<div class="team-row">';
    if (p.logoTrasferta) html += '<img src="' + p.logoTrasferta + '" class="compact-logo">';
    html += '<span>' + trasf + '</span>';
    html += '</div>';
    html += '</div>';

    // 1X2
    html += '<div class="lr-esito-multi">';
    html += '<div class="multi-bet">' + es1x2 + '</div>';
    if (perc1x2) html += '<div class="multi-perc">' + perc1x2 + '%</div>';
    html += '</div>';

    // O/U
    html += '<div class="lr-esito-multi">';
    html += '<div class="multi-bet">' + esOU + '</div>';
    if (percOU) html += '<div class="multi-perc">' + percOU + '%</div>';
    html += '</div>';

    // G/NG
    html += '<div class="lr-esito-multi">';
    html += '<div class="multi-bet">' + esGN + '</div>';
    if (percGN) html += '<div class="multi-perc">' + percGN + '%</div>';
    html += '</div>';

    html += '</div>';
  });

  c.innerHTML = html;
}





function displayRisultati(data, prefix) {
    const c = document.getElementById('risultati-content');
    if (!data.risultati || data.risultati.length === 0) { 
        c.innerHTML = `<div class="card"><div class="card-body text-center text-secondary">Nessun risultato recente.</div></div>`; 
        return; 
    }
    
    let html = `<h3 class="section-title" style="font-size: 1.3rem; color: var(--text-secondary); border: none;">Ultimo Turno: Giornata ${data.giornata}</h3>`;
    html += '<div class="table-container"><table class="table"><thead><tr>';
    html += '<th>Partita</th><th class="text-center">Risultato</th><th class="text-center">Esito</th><th class="text-center">1¬∞ Tempo</th>';
    html += '</tr></thead><tbody>';
    
    data.risultati.forEach(r => {
        html += `<tr>`;
        html += `<td><div class="text-strong">${r.casa} - ${r.trasferta}</div><div style="font-size: 0.8rem; color: var(--text-secondary);">${r.data}</div></td>`;
        html += `<td class="text-center text-strong">${r.risultato}</td>`;
        html += `<td class="text-center text-strong ${r.esito === '1' ? 'text-green' : r.esito === '2' ? 'text-red' : 'text-gold'}">${r.esito}</td>`;
        html += `<td class="text-center text-secondary">${r.parziale}</td>`;
        html += `</tr>`;
    });
    
    html += '</tbody></table></div>';
    c.innerHTML = html;
}

function displayClassifichePerCampionato(prefix) {
    const c = document.getElementById('classifiche-content');
    const camp = cache.classifiche[prefix];
    
    if (!camp || !camp.generale?.length) {
        c.innerHTML = `<div class="card"><div class="card-body text-center text-secondary">Classifica non disponibile.</div></div>`;
        return;
    }
    
    let html = `<div class="card">
        <div class="card-header"><h3 class="card-title">${camp.nome}</h3></div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>#</th><th>Squadra</th><th>Pt</th><th>G</th>
                        <th>V</th><th>N</th><th>P</th><th>DR</th><th>Forma</th>
                    </tr>
                </thead>
                <tbody>`;
    
    camp.generale.forEach(t => {
        html += `<tr>
            <td class="text-strong">${t.posizione}</td>
            <td>${t.squadra}</td>
            <td class="text-strong text-gold">${t.punti}</td>
            <td>${t.partite}</td>
            <td class="text-green">${t.vinte}</td>
            <td>${t.pareggiate}</td>
            <td class="text-red">${t.perse}</td>
            <td class="${t.differenzaReti > 0 ? 'text-green' : t.differenzaReti < 0 ? 'text-red' : ''}">${t.differenzaReti}</td>
            <td style="font-size: 0.8rem;">${t.forma || '-----'}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div></div>';
    c.innerHTML = html;
}

function displayStatistiche(data) {
  
  const c = document.getElementById(containerId);
  if (!c) return;

  if (!data || (data.marcatori.length === 0 && data.assist.length === 0 && data.cartellini.length === 0)) {
    c.innerHTML = `
      <div class="card">
        <div class="card-body text-center">
          <div class="text-secondary">Nessun dato disponibile.</div>
          <button class="btn" onclick="generaPrevisioniManualmente()" 
                  style="margin-top: 1rem; background: var(--accent-gold); color: var(--bg-primary);">
            üîÑ Genera Previsioni
          </button>
        </div>
      </div>`;
    return;
  }

  let html = '<div class="stats-grid">';

  const sections = [
    { 
      title: '‚öΩ Probabili Marcatori',
      data: data.marcatori,
      value: 'Gol',
      color: 'text-green',
      extra: (g) => `xG: ${g.xG || '0'}`
    },
    { 
      title: 'üéØ Probabili Assistman',
      data: data.assist,
      value: 'Ast',
      color: 'text-green',
      extra: (g) => `xA: ${g.xA || '0'}`
    },
    { 
      title: 'üü® Probabili Cartellini',
      data: data.cartellini,
      value: 'Gialli',
      color: 'text-gold',
      extra: (g) => `Falli: ${g.falliCommessi || 0}`
    }
  ];

  sections.forEach(s => {
    if (s.data.length > 0) {
      html += `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">${s.title}</h3>
          </div>
          <div class="card-body" style="padding:0;">
            <table class="table">
              <tbody>`;

      s.data.slice(0, 5).forEach(g => {
      
        html += `
<tr>
  <td style="display:flex; align-items:center; gap:12px; padding:10px;">
    
        
    <div>
      <div class="text-strong">${g.giocatore}</div>

      <div style="font-size: 0.8rem; color: var(--text-secondary);">
        ${g.squadra} | ${g.partita}
      </div>

      <div style="font-size: 0.7rem; color: var(--text-secondary);">
        ${s.extra(g)}
      </div>
    </div>

  </td>

  <td class="text-center text-strong ${s.color}"
      style="white-space:nowrap; font-size:1rem;">
      ${g.probabilita}
  </td>

  <td class="text-center text-secondary" style="white-space:nowrap;">
      ${g.stats} ${s.value}
  </td>
</tr>`;
      });

      html += `
              </tbody>
            </table>
          </div>
        </div>`;
    }
  });

  html += '</div>';
  c.innerHTML = html;
}


function displayStatisticheHome(data, containerId) {
  const c = document.getElementById(containerId);
  if (!c) return;

  if (!data || 
      (data.marcatori.length === 0 &&
       data.assist.length === 0 &&
       data.cartellini.length === 0)) {

    c.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-secondary">
          Nessun dato giocatori disponibile.
        </div>
      </div>`;
    return;
  }

  let html = '<div class="stats-grid">';

  const sections = [
    { title: '‚öΩ Marcatori', data: data.marcatori, value: 'Gol' },
    { title: 'üéØ Assist', data: data.assist, value: 'Ast' },
    { title: 'üü® Cartellini', data: data.cartellini, value: 'Gialli' }
  ];

  sections.forEach(s => {
    if (!s.data || s.data.length === 0) return;

    html += `
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">${s.title}</h3>
        </div>
        <div class="card-body" style="padding:0">
          <table class="table"><tbody>`;

    s.data.slice(0, 5).forEach(g => {
      html += `
        <tr>
          <td>${g.giocatore}<br>
              <small>${g.squadra}</small>
          </td>
          <td class="text-center text-strong">${g.probabilita}</td>
          <td class="text-center">${g.stats} ${s.value}</td>
        </tr>`;
    });

    html += `</tbody></table></div></div>`;
  });

  html += '</div>';
  c.innerHTML = html;
}
















// ========================================
// ADMIN FUNCTIONS
// ========================================
function setupSecretUpdate() {
    let clicks = 0;
    const logoArea = document.getElementById('secret-logo-area');
    
    if (logoArea) {
        logoArea.addEventListener('click', () => { 
            if (++clicks >= 5) { 
                document.getElementById('admin-panel').style.display = 'flex'; 
                alert('‚úÖ Modalit√† Professore Attivata!'); 
                clicks = 0; 
            }
        });
    }
    
    // Setup tutti i pulsanti admin
    setupAdminButtons();
     const btnApprendimento = document.getElementById('btn-admin-apprendimento');
  
}


// ========================================
// ADMIN PANEL - GESTIONE ATTIVATORI
// ========================================

function setupAdminButtons() {
    // GRUPPO 1: DATI BASE
    setupAdminBtn('btn-admin-risultati', 'att_1a_ImportaRisultati', 
        'Importare i risultati delle ultime partite?', 'üìä Risultati aggiornati!');
    
    setupAdminBtn('btn-admin-storico', 'att_1b_AggiornaStorico', 
        'Aggiornare lo storico con i risultati reali?', 'üìà Storico aggiornato!');
    
    // GRUPPO 2: CLASSIFICHE E STATS
    setupAdminBtn('btn-admin-classifiche', 'att_2a_ImportaClassifiche', 
        'Importare le classifiche aggiornate?', 'üèÜ Classifiche aggiornate!');
    
    setupAdminBtn('btn-admin-stats-a', 'att_2b_StatisticheSerieA', 
        'Importare statistiche Serie A?', '‚öΩ Statistiche Serie A importate!');
    
    setupAdminBtn('btn-admin-stats-b', 'att_2c_StatisticheSerieB', 
        'Importare statistiche Serie B?', 'ü•à Statistiche Serie B importate!');
    
    setupAdminBtn('btn-admin-stats-ucl', 'att_2d_StatisticheChampions', 
        'Importare statistiche Champions?', 'üèÜ Statistiche Champions importate!');
    
    // GRUPPO 3: CALENDARIO
    setupAdminBtn('btn-admin-calendario', 'att_3a_ImportaCalendario', 
        'Importare il calendario delle prossime partite?', 'üìÖ Calendario aggiornato!');
    
    setupAdminBtn('btn-admin-assenti', 'att_3b_AggiornaCacheAssenti', 
        'Aggiornare la cache degli assenti?', 'üè• Cache assenti aggiornata!');
    
    // GRUPPO 4: AI E PRONOSTICI
    setupAdminBtn('btn-admin-ml', 'att_4a_MachineLearning', 
        'Eseguire l\'analisi Machine Learning per tutti i campionati?', 'ü§ñ Machine Learning completato!');
    
    setupAdminBtn('btn-admin-pronostici', 'att_4b_PronosticiAvanzati', 
        'Generare i pronostici avanzati?', 'üéØ Pronostici generati!');
    
    setupAdminBtn('btn-admin-previsioni', 'att_4c_PrevisioniGiocatori', 
        'Generare le previsioni per i giocatori?', 'üë§ Previsioni giocatori generate!');
    
    setupAdminBtn('btn-admin-misterx', 'att_5_MisterX', 
        'Calcolare Mister X?', 'üé≠ Mister X calcolato!');
    
    // SEQUENZE COMPLETE
    const btnSequenzaManuale = document.getElementById('btn-admin-sequenza-manuale');
    if (btnSequenzaManuale) {
        btnSequenzaManuale.onclick = async function() {
            if (!confirm('‚ö†Ô∏è SEQUENZA COMPLETA MANUALE\n\n' +
                'Questa operazione eseguir√† tutti i 12 step in sequenza.\n' +
                'Pu√≤ richiedere 2-5 minuti e potrebbe andare in timeout.\n\n' +
                'Preferisci usare la Sequenza Automatica?\n\n' +
                'OK = Continua Manuale | Annulla = Ferma')) return;
            
            this.disabled = true;
            this.textContent = 'üîÑ Esecuzione in corso...';
            
            try {
                await runGAS('eseguiSequenzaManuale');
                alert('‚úÖ Sequenza completata!\n\nControlla i log per il riepilogo dettagliato.');
                clearCache();
                showSection(state.activeSection);
            } catch(e) {
                alert('‚ùå Errore:\n' + e.message + '\n\nAlcuni step potrebbero essere stati completati.');
            } finally {
                this.disabled = false;
                this.textContent = '‚ö° Esegui Sequenza Completa (Manuale)';
            }
        };
    }
    
    const btnSequenzaAuto = document.getElementById('btn-admin-sequenza-automatica');
    if (btnSequenzaAuto) {
        btnSequenzaAuto.onclick = async function() {
            if (!confirm('üöÄ SEQUENZA AUTOMATICA\n\n' +
                'Questa operazione programmer√† 12 trigger distanziati di 5 minuti.\n' +
                'Durata totale: ~60 minuti\n\n' +
                'Ogni step verr√† eseguito indipendentemente, evitando timeout.\n\n' +
                'Vuoi procedere?')) return;
            
            this.disabled = true;
            this.textContent = '‚è∞ Programmazione...';
            
            try {
                await runGAS('avviaSequenzaAutomatica');
                alert('‚úÖ Sequenza programmata con successo!\n\n' +
                      '12 step verranno eseguiti nei prossimi 60 minuti.\n' +
                      'Puoi monitorare l\'avanzamento in Apps Script > Esecuzioni');
                clearCache();
            } catch(e) {
                alert('‚ùå Errore nella programmazione:\n' + e.message);
            } finally {
                this.disabled = false;
                this.textContent = 'üöÄ Avvia Sequenza Automatica (60min)';
            }
        };
    }
    
    const btnStato = document.getElementById('btn-admin-stato');
    if (btnStato) {
        btnStato.onclick = async function() {
            this.disabled = true;
            this.textContent = 'üìä Caricamento...';
            
            try {
                await runGAS('mostraStatoAutomazione');
                alert('‚úÖ Controlla i log in Apps Script per vedere lo stato completo!\n\n' +
                      'Apps Script > Esecuzioni > Visualizza log');
            } catch(e) {
                alert('‚ùå Errore:\n' + e.message);
            } finally {
                this.disabled = false;
                this.textContent = 'üìä Mostra Stato Automazione';
            }
        };
    }
}

// Helper per configurare un singolo pulsante admin
function setupAdminBtn(btnId, funcName, confirmMsg, successMsg) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    
    btn.onclick = async function() {
        if (!confirm(confirmMsg)) return;
        
        const originalText = this.textContent;
        this.disabled = true;
        this.textContent = '‚è≥ Esecuzione...';
        
        try {
            await runGAS(funcName);
            alert(successMsg);
            clearCache();
            if (['btn-admin-pronostici', 'btn-admin-previsioni'].includes(btnId)) {
                showSection(state.activeSection);
            }
        } catch(e) {
            alert('‚ùå Errore:\n' + e.message);
        } finally {
            this.disabled = false;
            this.textContent = originalText;
        }
    };
}




async function runApprendimento(button) {
    const modal = document.getElementById("modal-apprendimento");
    const logArea = document.getElementById("modal-log");
    const loader = document.getElementById("modal-loading");
    
    modal.style.display = "flex";
    loader.style.display = "block";
    logArea.textContent = "üß† ANALISI APPRENDIMENTO IN CORSO\n";
    logArea.textContent += "========================================\n\n";
    
    if (button) {
        button.disabled = true;
        button.textContent = 'Analisi in corso...';
    }

    try {
        const prefixes = ["A", "B", "CA", "CB", "CC"];
        let risultatiCompleti = [];
        
        for (const prefix of prefixes) {
            logArea.textContent += `\n‚ñ∂Ô∏è Analisi Serie ${prefix}...\n`;
            
            try {
                const result = await runGAS("analizzaApprendimento", prefix);
                
                if (result?.success) {
                    logArea.textContent += `‚úÖ SUCCESSO: ${result.message}\n`;
                    
                    if (result.dettagliAnalisi) {
                        Object.entries(result.dettagliAnalisi).forEach(([key, value]) => {
                            logArea.textContent += `   üìä ${key}: ${value}\n`;
                        });
                    }
                    
                    risultatiCompleti.push({
                        campionato: prefix,
                        success: true,
                        dati: result.dettagliAnalisi
                    });
                    
                } else {

logArea.textContent += `‚ö†Ô∏è ATTENZIONE: ${result?.message || "Nessun risultato"}\n`;



                
                    if (result?.dettagli) {
                        logArea.textContent += `   ‚ÑπÔ∏è ${result.dettagli}\n`;
                    }
                    
                    risultatiCompleti.push({
                        campionato: prefix,
                        success: false,
                        errore: result?.error || "Unknown error"
                    });
                }
                
            } catch(err) {
                logArea.textContent += `‚ùå ERRORE: ${err.message || err}\n`;
                risultatiCompleti.push({
                    campionato: prefix,
                    success: false,
                    errore: err.message
                });
            }
            
            logArea.textContent += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
        }
        
        // RIEPILOGO FINALE
        loader.style.display = "none";
        logArea.textContent += "\nüèÅ RIEPILOGO FINALE\n";
        logArea.textContent += "========================================\n\n";
        
      const serieConDati = risultatiCompleti.filter(r => 
  r.success && r.dati && parseInt(r.dati["Partite 1X2"]) > 0);

const serieSenzaDati = risultatiCompleti.filter(r => 
  !r.success || !r.dati || parseInt(r.dati["Partite 1X2"]) === 0);

        
        logArea.textContent += `‚úÖ SERIE CON DATI: ${serieConDati.length}/${prefixes.length}\n`;
        serieConDati.forEach(serie => {
  logArea.textContent += `   ‚Ä¢ Serie ${serie.campionato}: ${serie.dati["Partite 1X2"]} partite\n`;
});
        
        
        if (serieSenzaDati.length > 0) {
            logArea.textContent += `\n‚ùå SERIE SENZA DATI: ${serieSenzaDati.length}/${prefixes.length}\n`;
            serieSenzaDati.forEach(serie => {
                logArea.textContent += `   ‚Ä¢ Serie ${serie.campionato}: ${serie.errore || "Dati insufficienti"}\n`;
            });
        }
        
        logArea.textContent += "\nüí° RACCOMANDAZIONI:\n";
        if (serieConDati.length === 0) {
            logArea.textContent += "   ‚Ä¢ Assicurati di aver eseguito 'Aggiorna Turno' per popolare lo Storico.\n";
        } else if (serieConDati.length < prefixes.length) {
            logArea.textContent += "   ‚Ä¢ Alcune serie hanno pochi dati. Attendi le prossime giornate.\n";
        } else {
            logArea.textContent += "   ‚Ä¢ Tutto ok! Il sistema sta imparando correttamente.\n";
        }
        
        clearCache();
        
    } catch (err) {
        loader.style.display = "none";
        logArea.textContent += `\nüí• ERRORE GENERALE: ${err.message || err}\n`;
    } finally {
        if (button) {
            button.disabled = false;
            button.textContent = 'Analizza AI';
        }
    }
}

function closeModal() { 
    document.getElementById("modal-apprendimento").style.display = "none"; 
}

function clearCache() {
    cache = { 
        top5Daily: null, 
        top5Weekend: null,
        pronostici: { A: null, B: null, CA: null, CB: null, CC: null }, 
        risultati: { A: null, B: null, CA: null, CB: null, CC: null }, 
        classifiche: { A: null, B: null, CA: null, CB: null, CC: null }, 
        statistiche: { A: null, B: null },
        socialData: { A: null, B: null, CA: null, CB: null, CC: null }
    };
}

// ========================================
// INIZIALIZZAZIONE FINALE
// ========================================

console.log('‚úÖ Le Dritte del Prof. - Sistema caricato correttamente');
console.log('ü§ñ Machine Learning attivo');


function caricaHome(tipo) {
    if (tipo === 'daily') loadTop5Daily();
    if (tipo === 'weekend') loadTop5Weekend();
}


function displaySorpreseForma(sorprese) {
  var c = document.getElementById('sorprese-forma-container');
  if (!c || !sorprese || !sorprese.length) {
    if (c) c.style.display = 'none';
    return;
  }

  var html = '';

  html += '<div class="list-header">';
  html += '<div class="lh-data">Data</div>';
  html += '<div class="lh-partita">Partita</div>';
  html += '<div class="lh-esito">Esito</div>';
  html += '</div>';

  sorprese.forEach(function(p) {

    var parts = (p.partita || '').split(' - ');
    var casa = parts[0] || '';
    var trasf = parts[1] || '';

    var data = '';
    var ora = '';

    if (p.data && p.data.indexOf(' ') > -1) {
      var d = p.data.split(' ');
      data = d[0] || '';
      ora = d[1].substring(0, 5);
    } else if (p.data) {
      ora = p.data.substring(0, 5);
    }

    var bestLabel = p.bestLabel || '';

    html += '<div class="list-row">';

    html += '<div class="lr-data">';
    html += (data ? data.substring(0, 5) : '') + '<br>' + ora;
    html += '</div>';

    html += '<div class="lr-partita">';
    html += '<div class="team-row">';
    if (p.logoCasa) {
      html += '<img src="' + p.logoCasa + '" class="compact-logo">';
    }
    html += '<span>' + casa + '</span>';
    html += '</div>';

    html += '<div class="team-row">';
    if (p.logoTrasferta) {
      html += '<img src="' + p.logoTrasferta + '" class="compact-logo">';
    }
    html += '<span>' + trasf + '</span>';
    html += '</div>';
    html += '</div>';

    html += '<div class="lr-esito">';
    html += '<div class="compact-bet">' + bestLabel + '</div>';
    html += '</div>';

    html += '</div>';
  });

  html += '<div class="prof-footer">';
  html += '<img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">';
  html += '<span>By Le dritte del Prof.</span>';
  html += '</div>';

  c.innerHTML = html;
  c.style.display = 'block';
}



// ========================================
// FUNZIONE SCARICA IMMAGINE SEMPLIFICATA
// ========================================

function scaricaImmagineAutomatica() {
    const btnScarica = document.getElementById('btn-scarica-immagine');
    const modalContent = document.getElementById('modal-social-content');
    
    if (!btnScarica || !modalContent) {
        alert('Elementi non trovati');
        return;
    }
    
    const testoOriginale = btnScarica.textContent;
    btnScarica.textContent = 'üîÑ Generando...';
    btnScarica.disabled = true;
    
    html2canvas(modalContent, {
        backgroundColor: '#0a0a0a',
        scale: 2,
        useCORS: true,
        allowTaint: true,
        logging: false,
        width: modalContent.scrollWidth,
        height: modalContent.scrollHeight,
        scrollX: 0,
        scrollY: 0,
        windowWidth: modalContent.scrollWidth,
        windowHeight: modalContent.scrollHeight
    }).then(canvas => {
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `pronostici-prof-${new Date().toISOString().split('T')[0]}.png`;
            link.href = url;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            btnScarica.textContent = '‚úÖ Scaricato!';
            btnScarica.style.backgroundColor = 'var(--accent-green)';
            
            setTimeout(() => {
                btnScarica.textContent = testoOriginale;
                btnScarica.style.backgroundColor = 'var(--accent-gold)';
                btnScarica.disabled = false;
            }, 2000);
            
        }, 'image/png', 1.0);
        
    }).catch(error => {
        console.error('Errore:', error);
        alert('Errore nella generazione dell\'immagine. Riprova.');
        btnScarica.textContent = testoOriginale;
        btnScarica.disabled = false;
    });
}
// ========================================
// FUNZIONI PER GRAFICA GIOCATORI
// ========================================

function openPlayersPreview(tipo) {
    const modal = document.getElementById("modal-social-preview");
    const content = document.getElementById("modal-social-content");
    const prefix = state.socialCampionato;
    
    // ‚úÖ Verifica che il campionato supporti statistiche
    if (!['A', 'B', 'UCL'].includes(prefix)) {
        alert('‚ùå Le statistiche giocatori sono disponibili solo per Serie A, Serie B e Champions League');
        return;
    }
    
    // Nascondi scrollbar
    document.body.style.overflow = 'hidden';
    
    // Titolo modale
    const titoli = {
        'marcatori': '‚öΩ Probabili Marcatori',
        'assist': 'üéØ Probabili Assistman',
        'cartellini': 'üü® Probabili Cartellini'
    };
    
    const modalTitle = document.querySelector('#modal-social-preview .modal-title');
    if (modalTitle) {
        modalTitle.textContent = `üñºÔ∏è ${titoli[tipo]} - ${prefix === 'A' ? 'Serie A' : 'Serie B'}`;
    }
    
    // Loading
    content.innerHTML = `
        <div class="loading" style="padding: 3rem;">
            <div class="spinner"></div>
            <p>Caricamento grafica ${titoli[tipo].toLowerCase()}...</p>
        </div>`;
    modal.style.display = "flex";

    // Collega pulsante download
    const btnScarica = document.getElementById('btn-scarica-immagine');
    if (btnScarica) {
        btnScarica.onclick = scaricaImmagineAutomatica;
    }

    // Chiamata backend
    runGAS('generaHtmlGiocatori', prefix, tipo)
        .then(res => {
            if (res && res.success && res.html) {
                setTimeout(() => {
                    content.innerHTML = res.html;
                    content.style.justifyContent = 'flex-start';
                    content.style.padding = '30px 20px';
                }, 100);
            } else {
                throw new Error(res.error || "Impossibile generare la grafica.");
            }
        })
        .catch(err => {
            console.error('Errore openPlayersPreview:', err);
            content.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 2rem;">
                    <div class="card" style="background: var(--accent-red); max-width: 500px;">
                        <div class="card-body" style="text-align: center;">
                            <strong>‚ùå Errore:</strong><br>
                            ${err.message || err.toString()}<br><br>
                            <small>Assicurati di aver generato le previsioni giocatori dal menu Statistiche</small>
                        </div>
                    </div>
                </div>`;
        });
}

// Aggiorna anche initSocialTabs per gestire solo A e B
function initSocialTabs() {
    const socialSection = document.getElementById('social-section');
    if (!socialSection) return;
    
    socialSection.querySelectorAll('.tab-btn').forEach(tab => {
        tab.addEventListener('click', () => {
            state.socialCampionato = tab.dataset.campionato;
            updateActiveTabs('#social-section', state.socialCampionato);
            
            // Nascondi pulsanti giocatori SOLO per Serie C e TOP5
            const playersButtons = socialSection.querySelectorAll('.social-btn[onclick*="Players"]');
            playersButtons.forEach(btn => {
                if (['CA', 'CB', 'CC', 'TOP5'].includes(state.socialCampionato)) {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.disabled = true;
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.disabled = false;
                }
            });
            
            // Clear preview
            document.getElementById('social-preview').style.display = 'none';
            document.getElementById('copy-social-btn').style.display = 'none';
        });
    });
}

// ========================================
// MISTER X FUNCTIONS
// ========================================

/**
/**
 * Carica i dati Mister X
 */
async function loadMisterX_Home() {
    const containerId = "home-misterx";
    const container = document.getElementById(containerId);

    if (!container) return;

    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Analisi Mister X in corso...</p>
        </div>
    `;

    try {
        const res = await runGAS("getMisterXForWeb");

       
if (res?.success && res.misterX?.length > 0) {
    displayMisterX(res);
} else {
    container.innerHTML = `
        <div class="card">
            <div class="card-body text-center text-secondary">
                Nessun Mister X disponibile.
            </div>
        </div>`;
}

    } catch (err) {
        console.error("‚ùå Errore Mister X:", err);
        container.innerHTML = `
            <div class="card">
                <div class="card-body text-center text-red">
                    Errore tecnico Mister X
                </div>
            </div>`;
    }
}


/**
 * Mostra i risultati Mister X
 */
function displayMisterX(data) {
  const listContainer = document.getElementById('misterXList');

  if (!data || !data.misterX || data.misterX.length === 0) {
    listContainer.innerHTML = `
      <div class="card">
        <div class="card-body text-center">
          üéØ Nessun Mister X disponibile al momento
        </div>
      </div>`;
    return;
  }

  // Filtra solo partite future
  const oggi = new Date();
  oggi.setHours(0, 0, 0, 0);

  const xFuture = data.misterX.filter(x => {
    if (!x.data) return true;
    const parts = x.data.split(/[,\s:]+/);
    if (parts.length >= 1) {
      const d = parts[0].split('/');
      if (d.length === 3) {
        const dataPartita = new Date(d[2], d[1] - 1, d[0]);
        return dataPartita >= oggi;
      }
    }
    return true;
  });

  if (xFuture.length === 0) {
    listContainer.innerHTML = `
      <div class="card">
        <div class="card-body text-center">
          üéØ Nessuna X futura disponibile
        </div>
      </div>`;
    return;
  }

  let html = '';

  xFuture.forEach(x => {
    const [casa, trasf] = x.partita.split(' - ');

    // ‚úÖ Percentuale sicura
    const perc = parseFloat(String(x.probX || x.percentuale || 0).replace('%','')) || 0;

    html += `
      <div class="prediction-card">

        <div class="prediction-header">
          <span>${x.data || ''}</span>
          <span>${x.campionato || ''}</span>
        </div>

        <div class="prediction-match-row">

          <div class="team-block">
            ${x.logoCasa ? `<img class="team-logo" src="${x.logoCasa}">` : ''}
            <div class="team-name">${casa}</div>
          </div>

          <div class="bestbet-box">
            <div class="bestbet-value">X</div>
            <div class="bestbet-perc">${perc > 0 ? perc.toFixed(0) + '%' : '‚Äî'}</div>
          </div>

          <div class="team-block">
            ${x.logoTrasferta ? `<img class="team-logo" src="${x.logoTrasferta}">` : ''}
            <div class="team-name">${trasf}</div>
          </div>

        </div>

      </div>
    `;
  });

  listContainer.innerHTML = html;
}




// ================================
// PROSSIME PARTITE
// ================================

const SHEET_BASE = "https://opensheet.elk.sh/1jP12u6u9fZkzfLAfvsBKTKkiBgartzhCCk3CKCFcR7Q";
const LOGO_BASE  = "https://media.api-sports.io/football/teams/";

// ‚úÖ CLASSI CAMPIONATO


function classeCampionato(nome) {
  if (!nome) return "";
  nome = nome.toLowerCase();
  if (nome.includes("serie a")) return "campionato-seriea";
  if (nome.includes("serie b")) return "campionato-serieb";
  if (nome.includes("serie c")) return "campionato-seriec";
  if (nome.includes("champions")) return "campionato-champions";
  return "";
}


// ‚úÖ FORMATTA DATA e ORA DA DATA_ISO
function formatDataOra(iso) {
  if (!iso) return "";
  const d = new Date(iso);

  const giorno = String(d.getDate()).padStart(2, "0");
  const mese   = String(d.getMonth() + 1).padStart(2, "0");
  const anno   = d.getFullYear();
  const ore    = String(d.getHours()).padStart(2, "0");
  const min    = String(d.getMinutes()).padStart(2, "0");

  return `${giorno}/${mese}/${anno} ‚Ä¢ ${ore}:${min}`;
}



function getLogoBySquadra(nomeSquadra) {
  return ""; // ‚úÖ Disattivata ricerca logo da cache che non esiste nello scope
}




function displayRisultatiEsattiHome(lista) {
  const container = document.getElementById("home-risultati");

  if (!container) {
    console.error("Container non trovato: home-risultati");
    return;
  }

  if (!Array.isArray(lista) || lista.length === 0) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-secondary">
          Nessun risultato esatto disponibile.
        </div>
      </div>`;
    return;
  }

  let html = `
    <div class="list-header">
      <div class="lh-data">Data</div>
      <div class="lh-partita">Partita</div>
      <div class="lh-esito">Esatto</div>
    </div>
  `;

  lista.forEach(r => {

    const [casa, trasf] = (r.partita || "").split(" - ");

    // üìÖ DATA SENZA ANNO E SENZA SECONDI
    let dataTxt = "";
    let oraTxt = "";

    if (r.dataISO) {
      const d = new Date(r.dataISO);
      dataTxt = d.toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit" });
      oraTxt  = d.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
    }
    console.log("RISULTATI ESATTI HOME:", lista);
    html += `
      <div class="list-row">

        <div class="lr-data">${dataTxt} - ${oraTxt}</div>

        <div class="lr-partita">
          <div class="team-row">
            ${r.logoCasa ? `<img src="${r.logoCasa}" class="compact-logo">` : ""}
            <span>${casa || ""}</span>
          </div>
          <div class="team-row">
            ${r.logoTrasferta ? `<img src="${r.logoTrasferta}" class="compact-logo">` : ""}
            <span>${trasf || ""}</span>
          </div>
          <div style="font-size:11px; color:#64748b;">
            ${r.campionato || ""}
          </div>
        </div>

        <div class="lr-esito">
          <div class="compact-bet">${r.risultato || r.esatto || "‚Äî"}</div>
        </div>

      </div>
    `;
  });

  html += `
    <div class="prof-footer">
      <img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">
      <span>By Le dritte del Prof.</span>
    </div>
  `;

  container.innerHTML = html;
}





async function loadRisultatiEsatti() {
  const container = document.getElementById("home-risultati");

  if (!container) {
    console.error("home-risultati non trovato");
    return;
  }

  container.innerHTML = `
    <div class="loading">
      <p>‚è≥ Caricamento Risultati Esatti...</p>
    </div>
  `;

  try {
    const res = await runGAS("getRisultatiEsattiForWeb");

    console.log("RIS ESATTI RAW:", res); // üî• LOG FONDAMENTALE

    // ‚úÖ NORMALIZZAZIONE TOTALE
    let lista = [];

    if (Array.isArray(res)) {
      lista = res;
    } else if (Array.isArray(res?.data)) {
      lista = res.data;
    } else if (Array.isArray(res?.risultati)) {
      lista = res.risultati;
    }

    displayRisultatiEsattiHome(lista);

  } catch (err) {
    console.error("Errore Risultati Esatti:", err);
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-secondary">
          Errore caricamento Risultati Esatti
        </div>
      </div>`;
  }
}



async function loadComboConsigliate() {
    const containerId = "home-combo";
    setLoading(containerId, "Analisi combo in corso...");

    try {
        console.log("üì° Chiamata GAS combo...");
        const res = await runGAS("getComboConsigliateForWeb");
        console.log("üì• Risposta GAS:", res);

        if (res?.success && Array.isArray(res.combo) && res.combo.length > 0) {
            displayComboConsigliate(res.combo, containerId);
        } else {
            document.getElementById(containerId).innerHTML =
                `<div class="card"><div class="card-body text-center text-secondary">
                    Nessuna combo disponibile.
                 </div></div>`;
        }
    } catch (err) {
        console.error("‚ùå Errore combo:", err);
        document.getElementById(containerId).innerHTML =
            `<div class="card"><div class="card-body text-center text-red">
                Errore tecnico combo
             </div></div>`;
    }
}



function displayRisultatiEsattiHome(lista) {
  const container = document.getElementById("home-risultati");

  if (!container) {
    console.error("Container non trovato: home-risultati");
    return;
  }

  if (!Array.isArray(lista) || lista.length === 0) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-secondary">
          Nessun risultato esatto disponibile.
        </div>
      </div>`;
    return;
  }

  let html = `
    <div class="list-header">
      <div class="lh-data">Data</div>
      <div class="lh-partita">Partita</div>
      <div class="lh-esito">Risultato</div>
    </div>
  `;

  lista.forEach(r => {

    const [casa, trasf] = (r.partita || "").split(" - ");

    html += `
      <div class="list-row">

        <!-- DATA -->
        <div class="lr-data">  ${r.data? r.data.replace(/\/\d{4},/, "").replace(",", " -"): ""}</div>

        <!-- PARTITA -->
        <div class="lr-partita">
          <div class="team-row">
            <span>${casa || ""}</span>
          </div>
          <div class="team-row">
            <span>${trasf || ""}</span>
          </div>
          <div style="font-size:11px; color:#64748b;">
            ${r.campionato || ""}
          </div>
        </div>

        <!-- RISULTATO ESATTO -->
        <div class="lr-esito">
          <div class="compact-bet">${r.risultato || "‚Äî"}</div>
        </div>

      </div>
    `;
  });

  html += `
    <div class="prof-footer">
      <img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">
      <span>By Le dritte del Prof.</span>
    </div>
  `;

  container.innerHTML = html;
}









function displayComboConsigliate(lista) {
    const container = document.getElementById("comboList");
    if (!container) return;

    let html = `
        <div class="list-header">
            <div class="lh-data">Data</div>
            <div class="lh-partita">Partita</div>
            <div class="lh-esito">Combo</div>
        </div>
    `;

    lista.forEach((c, i) => {
        const [casa, trasf] = c.partita.split(" - ");
        
        // data + ora
        let dataTxt = "";
        let oraTxt = "";
        if (c.data.includes(" ")) {
            const parts = c.data.split(" ");
            dataTxt = parts[0].substring(0, 5);
            oraTxt = parts[1].substring(0, 5);
        }

        const perc = c.percentuale || (c.score * 100).toFixed(2) + "%";

        html += `
            <div class="list-row">

                <div class="lr-data">${dataTxt} - ${oraTxt}</div>

                <div class="lr-partita">
                    <div class="team-row"><span>${casa}</span></div>
                    <div class="team-row"><span>${trasf}</span></div>
                </div>

               <div class="lr-esito combo-cell">
                  <span class="combo-pill">${c.combo}</span>
                  <div class="mini-perc">${perc}</div>
              </div>

            </div>
        `;
    });

    html += `
        <div class="prof-footer">
            <img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">
            <span>By Le dritte del Prof.</span>
        </div>
    `;

    container.innerHTML = html;
}


// =======================
// PROSSIME PARTITE - LOADER
// =======================


function caricaProssime(prefix) {
  console.log("‚ñ∂ caricaProssime:", prefix);

  const content = document.getElementById("prossime-content");
  const loading  = document.getElementById("prossime-loading");

  if (!content || !loading) {
    console.warn("‚ö† prossime-content o prossime-loading non presenti in questa sezione");
    return;
  }
  content.innerHTML = "";
  loading.style.display = "block";

  // Tab attiva
  document
    .querySelectorAll("#prossime-partite-section .tab-btn")
    .forEach(btn => btn.classList.remove("active"));

  const activeBtn = document.querySelector(
    `#prossime-partite-section .tab-btn[data-sheet='${prefix}']`
  );
  if (activeBtn) activeBtn.classList.add("active");

  const sheetName = encodeURIComponent(prefix + " - Prossime Partite");
  const url = `${SHEET_BASE}/${sheetName}`;

  console.log("üåê FETCH:", url);

  fetch(url)
    .then(res => {
      console.log("‚úÖ STATUS:", res.status);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    })
    .then(data => {
      console.log("‚úÖ DATI:", data);

      if (!Array.isArray(data) || data.length === 0) {
        content.innerHTML = "<p class='text-center'>Nessuna partita disponibile</p>";
        return;
      }

      data.sort((a, b) => new Date(a.DATA_ISO) - new Date(b.DATA_ISO));

 data.forEach(match => {
  const card = document.createElement("div");
  const cls  = classeCampionato(match.Campionato);
  card.className = "card " + cls;

  const logoCasa =
    match["Logo Casa"] || getLogoBySquadra(match.Casa) || "";

  const logoTrasferta =
    match["Logo Trasferta"] || getLogoBySquadra(match.Trasferta) || "";

  const logoCasaHTML = logoCasa
    ? `<img src="${logoCasa}" class="prossime-logo" onerror="this.style.display='none'">`
    : "";

  const logoTrasfHTML = logoTrasferta
    ? `<img src="${logoTrasferta}" class="prossime-logo" onerror="this.style.display='none'">`
    : "";

  card.innerHTML = `
    <div class="prossima-row">
      <div class="prossima-sinistra">
        ${logoCasaHTML}
        <span class="prossima-squadra">${match.Casa}</span>

        <span class="prossima-vs">-</span>

        ${logoTrasfHTML}
        <span class="prossima-squadra">${match.Trasferta}</span>
      </div>

      <div class="prossima-destra">
        ${formatDataOra(match.DATA_ISO)} ‚Ä¢ Giornata ${match.Giornata}
      </div>
    </div>
  `;

  content.appendChild(card);
});

    })
    .catch(err => {
      console.error("‚ùå ERRORE FETCH:", err);
      content.innerHTML = "<p class='text-center text-red'>Errore caricamento partite</p>";
    })
    .finally(() => {
      // ‚úÖ BLOCCO DEFINITIVO DEL LOADER
      loading.style.display = "none";
      console.log("‚úÖ Loader spento forzatamente");
    });
}

console.log("‚úÖ JS CARICATO CORRETTAMENTE");


  document.querySelectorAll("#prossime-partite-section .tab-btn")
    .forEach(btn => {
      btn.addEventListener("click", () => {
        const prefix = btn.dataset.sheet;
        loadProssime(prefix);
      });
    });


async function loadTop1X2Weekend_Home() {
  const container = document.getElementById("home-1x2-weekend");
  if (!container) return;

  container.innerHTML = `<div class="loading">Analisi 1X2 Weekend...</div>`;

  try {
    const res = await runGAS("getTop1X2WeekendForWeb");
    displayTop1X2Weekend_Home(res); // ‚úÖ PASSI TUTTO
  } catch (err) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-red">
          Errore caricamento 1X2
        </div>
      </div>`;
  }
}


function displayTop1X2Weekend_Home(res) {
  const container = document.getElementById("home-1x2-weekend");

  if (!container) {
    console.error("Container non trovato: home-1x2-weekend");
    return;
  }

 if (!res || !res.success || !res.top || (Array.isArray(res.top) && res.top.length === 0)) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body text-center text-secondary">
          Nessun 1X2 forte disponibile per il weekend.
        </div>
      </div>`;
    return;
  }

  // Normalizza: singolo o array
  const lista = Array.isArray(res.top) ? res.top : [res.top];

  let html = `
    <div class="list-header">
      <div class="lh-data">Data</div>
      <div class="lh-partita">Partita</div>
      <div class="lh-esito">1X2</div>
    </div>
  `;

  lista.forEach(p => {

    const [casa, trasf] = (p.partita || "").split(" - ");

    // DATA SENZA ANNO E SENZA SECONDI
    let dataTxt = "";
    let oraTxt = "";
    if (p.dataISO) {
      const d = new Date(p.dataISO);
      dataTxt = d.toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit" });
      oraTxt  = d.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
    }

    html += `
      <div class="list-row">

        <!-- DATA -->
        <div class="lr-data">${dataTxt} - ${oraTxt}</div>

        <!-- PARTITA -->
        <div class="lr-partita">
          <div class="team-row">
            ${p.logoCasa ? `<img src="${p.logoCasa}" class="compact-logo">` : ""}
            <span>${casa || ""}</span>
          </div>
          <div class="team-row">
            ${p.logoTrasferta ? `<img src="${p.logoTrasferta}" class="compact-logo">` : ""}
            <span>${trasf || ""}</span>
          </div>
          <div style="font-size:11px; color:#64748b; margin-top:2px;">
            ${p.campionato || ""}
          </div>
        </div>

        <!-- ESITO -->
        <div class="lr-esito">
          <div class="compact-bet">${p.bestEsito || p.esito || "‚Äî"}</div>
        </div>

      </div>
    `;
  });

  html += `
    <div class="prof-footer">
      <img src="https://lh3.googleusercontent.com/d/1lmKYeW8AavhBtnRwQIDkDiGjN4SOk4LP">
      <span>By Le dritte del Prof.</span>
    </div>
  `;

  container.innerHTML = html;
}












console.log("FINE FILE OK");





</script>
</body>
</html>
